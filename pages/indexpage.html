<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">-->

    <title>歡迎蒞臨大同世界科技</title>

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="/vendor/bootstrap/css/bootstrap.css" type="text/css">

    <!-- Custom styles for this template -->
    <link rel="stylesheet" href="/css/simple-sidebar.css" type="text/css">

</head>

<body>

    <div id="wrapper">

        <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <li class="sidebar-brand">
                    <img id="tstipng" src="https://caserverhtmltest.herokuapp.com/images/tstiball.png">
                </li>
                <li>
                    <a href="#">首頁</a>
                </li>
                <li>
                    <a target="_blank" rel="noopener noreferrer" href="https://www.etungo.com.tw/">大同e同購</a>
                </li>
                <!--
                <li>
                    <a href="#">Overview</a>
                </li>
                <li>
                    <a href="#">Events</a>
                </li>
                <li>
                    <a href="#">About</a>
                </li>
                <li>
                    <a href="#">Services</a>
                </li>
                <li>
                    <a href="#">Contact</a>
                </li>
                -->
            </ul>
        </div>
        <!-- /#sidebar-wrapper -->
        <div id="pagetop">
            <p id="loginname"></p>
            <p id="pagelogout" style="margin-top: -15px">登出</p>
        </div>
        <!-- Page Content -->
        <div id="page-content-wrapper">
            <div class="container">
                <div class="row">
                    <div style="width:800px">
                        <h1>歡迎蒞臨大同世界科技</h1>
                        <h5>請說出您要找的人名: </h5>
                        <h5>請輸入您要找的人名: <input id="searchdata" class="form-control" onkeypress="keysearch()"><button id="getcontacts"
                                type="submit" class="btn searchbtn" onclick="search()">搜尋</button></h5>
                    </div>
                </div>
            </div>
            <!--<div class="container">
                <div class="row">
                    <table id="userdata" class="table table-bordered tableresize">
                        <tr>
                            <td class="tdresize"><img src="https://caserverhtmltest.herokuapp.com/images/tatungba.jpg"
                                    class="rounded-circle img-fluid d-block employeespic">
                            </td>
                            <td>
                                <table class="table table-bordered">
                                    <tr>
                                        <td>
                                            <h3 id="username"></h3>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <h3 id="userdepart"></h3>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><button id="tstimakecall" type="submit" class="btn caserverbtn" value="">撥打桌上電話</button>
                                            <button id="holdcall" type="submit" class="btn caserverbtn" value="" style="display:none">保留電話</button>
                                            <button id="retrievecall" type="submit" class="btn caserverbtn" value=""
                                                style="display:none">接回電話</button>
                                            <button id="tstiendcall" type="submit" class="btn caserverbtn" value=""
                                                style="display:none">掛斷電話</button>
                                            <p id="showtext"></p>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><button id="tstimakephonecall" type="submit" class="btn caserverbtn">撥打行動電話</button></td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                    </table>
                </div>

            </div>-->
        </div>
        <!-- /#page-content-wrapper -->

    </div>
    <!-- /#wrapper -->
    <!--<div style="width:12000px;height:200px;background-color:blue;margin-left: 500px;overflow: scroll;">

    </div>-->
    <div style="overflow-x:auto;margin-left: 270px">
        <div id="divrow" class="row" style="height:430px; width: 330px;"><!--width:15720px;-->
            <!--background-color:blue;-->
            <table class="table table-bordered tableresize" style="margin-left:30px;">
                <tr id="appendforuser">
                    <!-- <td>
                        <table class="table table-bordered">
                            <tr>
                                <td class="tdresize">
                                    <img src="https://caserverhtmltest.herokuapp.com/images/tatungba.jpg" class="rounded-circle img-fluid d-block employeespic">
                                </td>
                                <td>
                                    <table class="table table-bordered">
                                        <tr>
                                            <td>
                                                <h3 id="username"></h3>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <h3 id="userdepart"></h3>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><button id="tstimakecall" type="submit" class="btn caserverbtn" value="">撥打桌上電話</button>
                                                <button id="holdcall" type="submit" class="btn caserverbtn" value=""
                                                    style="display:none">保留電話</button>
                                                <button id="retrievecall" type="submit" class="btn caserverbtn" value=""
                                                    style="display:none">接回電話</button>
                                                <button id="tstiendcall" type="submit" class="btn caserverbtn" value=""
                                                    style="display:none">掛斷電話</button>
                                                <p id="showtext"></p>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><button id="tstimakephonecall" type="submit" class="btn caserverbtn">撥打行動電話</button></td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                        </table>
                    </td>
                    <td>
                        <table class="table table-bordered">
                            <tr>
                                <td class="tdresize">
                                    <img src="https://caserverhtmltest.herokuapp.com/images/tatungba.jpg" class="rounded-circle img-fluid d-block employeespic">
                                </td>
                                <td>
                                    <table class="table table-bordered">
                                        <tr>
                                            <td>
                                                <h3 id="username"></h3>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <h3 id="userdepart"></h3>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><button id="tstimakecall" type="submit" class="btn caserverbtn" value="">撥打桌上電話</button>
                                                <button id="holdcall" type="submit" class="btn caserverbtn" value=""
                                                    style="display:none">保留電話</button>
                                                <button id="retrievecall" type="submit" class="btn caserverbtn" value=""
                                                    style="display:none">接回電話</button>
                                                <button id="tstiendcall" type="submit" class="btn caserverbtn" value=""
                                                    style="display:none">掛斷電話</button>
                                                <p id="showtext"></p>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><button id="tstimakephonecall" type="submit" class="btn caserverbtn">撥打行動電話</button></td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                        </table>
                    </td>-->

                </tr>

            </table>
        </div>
    </div>

    <!-- Bootstrap core JavaScript -->
    <script src="/vendor/jquery/jquery.min.js"></script>
    <script src="/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script type="/text/javascript" src="/scripts/index.js"></script>
    <script type="text/javascript" src="/scripts/jquery/jquery-2.1.0.min.js"></script>

    <!-- Menu Toggle Script -->
    <script>
        var stationid = '';
        var callid = '';
        var Mytoken = '';
        var name = 'andy';
        var destinationid = '';
        var secondcount = 0;
        $(document).ready(function () {
            var displayName = JSON.stringify(mydata.displayName);
            displayName = displayName.replace('"', '').replace('"', '');
            var businessPhones = JSON.stringify(mydata.businessPhones);
            businessPhones = businessPhones.replace('[', '').replace(']', '').replace('"', '').replace('"', '');
            if (businessPhones == null) {
                businessPhones = "無分機";
            }
            if (businessPhones.length > 4) {
                businessPhones = businessPhones.slice(-4);
            }
            $('#loginname').text('您好 ' + displayName + '，您的分機: ' + businessPhones);
            stationid = businessPhones;
            $('.camakecall').click(function () { //撥出電話
                var destinationid = $(this).val();
                if (destinationid == null) {
                    //do
                } else {
                    //getToken(name, password, function (reg) {
                    getToken(name, '654321', function (reg) {
                        if (reg.success) {
                            Mytoken = reg.token;
                            $.ajax({
                                "async": true,
                                "crossDomain": true,
                                "url": 'https://tstiticctcstest.herokuapp.com/phone' + '/makecall',
                                //https://tstiticctcstest.herokuapp.com/phone
                                "method": "POST",
                                headers: {
                                    'accept': 'application/json',
                                    'x-access-token': Mytoken,
                                    'Content-Type': 'application/json',
                                    "cache-control": "no-cache"
                                },
                                "processData": false,
                                "data": JSON.stringify({
                                    "stationid": stationid,
                                    "destinationid": destinationid,
                                    "name": name
                                }),
                                success: function (reg) {
                                    checkStatus();
                                    if (reg.success === false) {
                                        $('#showtext').text("撥號失敗");
                                        setTimeout(checkStatus, 1000);
                                    } else {
                                        $('#showtext').text("正在撥號請等候...");
                                        //延遲一秒function checkStatus()，因為直接跑會出現結束通話狀態，延遲一秒後才會出現撥號中
                                        setTimeout(checkStatus, 1000);
                                        callid = reg.callid;
                                        //return callid;
                                    }
                                },
                                error: function (reg) {
                                    if (secondcount < 1) {
                                        secondcount++;
                                        $('#showtext').text("連線失敗...");
                                        setTimeout(function () {
                                            return checkStatus()
                                        }, 200);
                                    }
                                    //$('#makecall').trigger('click');
                                }
                            });

                        } else {
                            alert(reg.message + "........");
                        }
                    })

                }
            }) //end makecall

            $('.caholdcall').click(function () { //保留電話
                $.ajax({
                    "async": true,
                    "crossDomain": true,
                    "url": 'https://tstiticctcstest.herokuapp.com/phone' + '/holdcall',
                    "method": "POST",
                    headers: {
                        'accept': 'application/json',
                        'x-access-token': Mytoken,
                        'Content-Type': 'application/json',
                        "cache-control": "no-cache"
                    },
                    "processData": false,
                    "data": JSON.stringify({
                        "stationid": stationid,
                        "callid": callid,
                        "name": name
                    }),
                    success: function (reg) {
                        if (reg.success === false) {
                            $('#showtext').text("保留失敗");
                            $('#holdcall').show();
                        } else {
                            setTimeout(checkStatus, 1000);
                        }
                    }
                });
            });

            $('.caretrievecall').click(function () { //接回電話
                $.ajax({
                    "async": true,
                    "crossDomain": true,
                    "url": 'https://tstiticctcstest.herokuapp.com/phone' + '/retrievecall',
                    "method": "POST",
                    headers: {
                        'accept': 'application/json',
                        'x-access-token': Mytoken,
                        'Content-Type': 'application/json',
                        "cache-control": "no-cache"
                    },
                    "processData": false,
                    "data": JSON.stringify({
                        "stationid": stationid,
                        "callid": callid,
                        "name": name
                    }),
                    success: function (reg) {
                        if (reg.success === false) {
                            $('#showtext').text("接回失敗");
                            $('#retrievecall').show();
                            $('#endcall').show();
                        } else {
                            setTimeout(checkStatus, 1000);
                        }
                    }
                });
            });


            $('.caendcalll').click(function () { //結束電話
                $.ajax({
                    "async": true,
                    "crossDomain": true,
                    "url": 'https://tstiticctcstest.herokuapp.com/phone' + '/endcall',
                    "method": "POST",
                    headers: {
                        'accept': 'application/json',
                        'x-access-token': Mytoken,
                        'Content-Type': 'application/json',
                        "cache-control": "no-cache"
                    },
                    "processData": false,
                    "data": JSON.stringify({
                        "stationid": stationid,
                        "callid": callid,
                        "name": name
                    }),
                    success: function (reg) {
                        if (reg.success === false) {
                            $('#showtext').text("掛斷失敗");
                            $('#endcall').show();
                        } else {
                            checkStatus();
                        }
                    }
                });  //end post ajax
            });

        });

        $(document).ready(function () {

        });

        function keysearch() {
            /*var keysearch = $('#searchdata').val();
            var data = {
                keysearch: keysearch
            }
            $.post('/keysearch', data, function(resdata){
                alert(resdata);
            })*/
        }
        function search() {
            var searchdata = $('#searchdata').val();
            var data = {
                searchdata: searchdata
            }
            $.post('/search', data, function (resdata) {
                if (resdata === 'wrong') {
                    alert('查無資料');
                    $('#appendforuser').empty(); //清空appendforuser裡面所有node
                    $('#divrow').width(330);
                } else {
                    $('#appendforuser').empty(); //清空appendforuser裡面所有node
                    console.log(resdata);
                    resdata = JSON.parse(resdata);
                    var datalength = resdata.length;
                    $('#divrow').width(785*datalength);
                    $('.tableresize').width(755*datalength);
                    for(var i = 0; i < datalength; i++){
                        $('#appendforuser').append(
                            '<td id="newdata">'+
                                '<table class="table table-bordered">'+
                                    '<tr>'+
                                        '<td class="tdresize">'+
                                                '<img src="/images/tatungba.jpg" class="rounded-circle img-fluid d-block employeespic">'+
                                        '</td>'+
                                        '<td>'+
                                            '<table class="table table-bordered">'+
                                                '<tr>'+
                                                    '<td><h3 id="username' +i+ '"><h3>'+
                                                    '</td>'+
                                                '</tr>'+
                                                '<tr>'+
                                                    '<td><h3 id="userdepart' +i+ '"></h3>'+
                                                    '</td>'+
                                                '</tr>'+
                                                '<tr>'+
                                                    '<td><button id="tstimakecall' +i+ '" type="submit" class="btn caserverbtn camakecall" value="">撥打桌上電話</button>'+
                                                    '<button id="holdcall' +i+ '" type="submit" class="btn caserverbtn caholdcall" value="" style="display:none">保留電話</button>'+
                                                    '<button id="retrievecall' +i+ '" type="submit" class="btn caserverbtn caretrievecall" value="" style="display:none">接回電話</button>'+
                                                    '<button id="tstiendcall' +i+ '" type="submit" class="btn caserverbtn caendcall" value="" style="display:none">掛斷電話</button>'+
                                                    '<p id="showtext"></p>'+
                                                    '</td>'+
                                                '</tr>'+
                                                '<tr>'+
                                                    ' <td><button id="tstimakephonecall' +i+ '" type="submit" class="btn caserverbtn">撥打行動電話</button></td>'+
                                                '</tr>'+
                                            '</table>'+
                                        '</td>'+
                                    '</tr>'+
                                '</table>'+
                            '</td>'
                        );
                        $('#username'+i).text('姓名:' + resdata[i].displayName);
                        //$('#userdepart').text('單位:' + resdata.department);
                        $('#userdepart'+i).text('信箱:' + resdata[i].mail);
                        $('#tstimakecall'+i).text('撥打桌上電話' + (resdata[i].businessPhones));
                        $('#tstimakecall'+i).val(resdata[i].businessPhones);
                        $('#tstimakephonecall'+i).text('撥打行動電話' + (resdata[i].mobilePhone));
                        $('#tstimakephonecall'+i).val(resdata[i].mobilePhone);
                    }
                }
            })
        };

        function getToken(name, password, callback) {
            $.ajax({
                //url: String(caserverurl).split('/phone')[0] + '/authenticate/login', //https://tstiticctcstest.herokuapp.com/phone
                url: 'https://tstiticctcstest.herokuapp.com/authenticate/login',
                headers: {
                    'accept': 'application/json',
                    'Content-Type': 'application/json',
                    'Access-Control-Allow-Origin': "*",
                    'Access-Control-Allow-Methods': 'GET,PUT,POST,DELETE',
                    'Access-Control-Allow-Headers': 'X-Requested-With, Content-Type'
                },
                type: 'POST',
                data: JSON.stringify({
                    "name": name,
                    "password": password
                }),
                dataType: 'json',
                success: function (reg) {
                    console.log("token資訊: " + JSON.stringify(reg));
                    callback(reg);
                },
                error: function (reg) {
                    //alert("伺服器錯誤..........")
                    alert(JSON.stringify(reg));
                    //return callout(destination);
                }
            });
        }

        function checkStatus() {
            console.log("checkStatus >......");
            $.ajax({
                "async": true,
                "crossDomain": true,
                //"url": caserverurl + '/status/' + name + '?stationid=' + stationid,
                "url": 'https://tstiticctcstest.herokuapp.com/phone' + '/status/' + name + '?stationid=' + stationid,
                "method": "GET",
                headers: {
                    'x-access-token': Mytoken,
                    "cache-control": "no-cache"
                },
                success: function (reg) {
                    if (reg.success === false) {
                        if (reg.message === 'Can not find station status: ' + stationid) {
                            while (secondcount < 1) {
                                secondcount++;
                                setTimeout(function () {
                                    return checkStatus()
                                }, 1000);
                                $('#showtext').text("");
                            } //end while
                        } else {
                            if (secondcount < 1) {
                                secondcount++;
                                $('#showtext').text("檢查連線中...");
                                //setTimeout(checkStatus,1000);
                                setTimeout(function () {
                                    return checkStatus()
                                }, 200);
                            } else {
                                $('#showtext').text("連線失敗!......");
                            }
                        }
                    } else {
                        var callstatus = reg.status.status;
                        callid = reg.status.callid;
                        switch (callstatus) {
                            case "oncallconnect": //通話中
                                $('#makecall').hide();
                                $('#tstimakecall').hide();
                                $('#holdcall').show();
                                $('#retrievecall').hide();
                                $('#endcall').show();
                                $('#tstiendcall').show();
                                $('#showtext').text("通話中~");
                                setTimeout(checkStatus, 1000);
                                break;
                            case "oncallcreate": //撥號中
                                $('#endcall').show();
                                $('#tstiendcall').show();
                                $('#makecall').hide();
                                $('#tstimakecall').hide();
                                $('#showtext').text("撥號中...");
                                setTimeout(checkStatus, 1000);
                                break;
                            case "oncallend": //結束
                                $('#makecall').show();
                                $('#tstimakecall').show();
                                $('#holdcall').hide();
                                $('#retrievecall').hide();
                                $('#endcall').hide();
                                $('#tstiendcall').hide();
                                $('#showtext').text("");
                                break;
                            case "oncallhold": //保留中
                                $('#retrievecall').show();
                                $('#holdcall').hide();
                                $('#tstiendcall').show();
                                $('#showtext').text("保留中...");
                                setTimeout(checkStatus, 1000);
                                break;
                            case "oncallring": //響鈴中
                                //do
                                break;
                            default:
                            //do
                        }
                    }
                },
                error: function (reg) {
                    if (name == '' || stationid == '' || caserverurl == '') {
                        //$('#showtext').text("請檢查撥號話機和使用者帳號!");
                    } else {
                        if (secondcount < 1) {
                            secondcount++;
                            //$('#showtext').text("連線錯誤!..........");
                            setTimeout(function () {
                                return checkStatus()
                            }, 200);
                        }
                    }
                }
            });

        };
        $(document).ready(function () {
            $('#pagelogout').click(function () {
                alert('尚未完成');
            });
        });
    </script>

</body>

</html>