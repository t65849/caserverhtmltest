<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">-->

    <title>歡迎蒞臨大同世界科技</title>

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="pages/vendor/bootstrap/css/bootstrap.css" type="text/css">

    <!-- Custom styles for this template -->
    <link rel="stylesheet" href="pages/css/simple-sidebar.css" type="text/css">

</head>

<body id=indexbody oncontextmenu="return false">
    <!--id=indexbody-->
    <div id="wrapper">
        <!-- Sidebar -->
        <!--<div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <li class="sidebar-brand">
                    <img id="tstipng" src="https://caserverhtmltest.herokuapp.com/images/tstiball.png">
                </li>
                <li>
                    <a href="#">首頁</a>
                </li>
                <li>
                    <a target="_blank" rel="noopener noreferrer" href="https://www.etungo.com.tw/">大同e同購</a>
                </li>
                <li>
                    <a target="_blank" rel="noopener noreferrer" href="https://www.etatung.com/">大同世界科技</a>
                </li>
                <li>
                    <a href="#">Events</a>
                </li>
                <li>
                    <a href="#">About</a>
                </li>
                <li>
                    <a href="#">Services</a>
                </li>
                <li>
                    <a href="#">Contact</a>
                </li>
            </ul>
        </div>-->
        <!-- /#sidebar-wrapper -->
        <div id="pagetop" style="height:7vh;">
            <p id="loginname"></p>
            <!--<p id="pagelogout" style="margin-top: -15px">登出</p>-->
            <!--登出按鈕-->
        </div>
        <!-- Page Content -->
        <div id="page-content-wrapper">
            <div class="container">
                <div class="row">
                    <div style="width:100%;color:#022178;height:23vh;">
                        <h1 style="font-weight:bold;font-size: 52px">歡迎蒞臨大同世界科技</h1>
                        <table style="margin-top:10px">
                            <tr>
                                <td>
                                    <h4>請說"大同寶寶"幫您找同仁: <span id="speechStatue"></span></h4>
                                </td>
                                <td>
                                    <input id="voiceSearch" type="button" value="語音查詢" style="visibility:hidden" />
                                </td>
                            </tr>
                        </table>
                        <h4 style="margin-top:5px;">或輸入您要找的人名: <input id="searchdata" class="form-control">&nbsp;<button
                                id="getcontacts" type="submit" onclick="search()"
                                style="width:100px;visibility:hidden;">搜尋</button></h4>
                    </div>
                    <!--class="btn searchbtn"-->
                    <div id="scrollx" style="width:80vw; height:66.5vh; overflow-y:auto; overflow-x:auto;margin-top: 30px;">
                        <!--margin-left: 120px; margin-top: -25px;
                            style="width:34.5vw; height:95vh; overflow-y:auto; overflow-x:auto;-->
                        <!--<div id="divrow" class="row">-->
                        <!--width:15720px;-->
                        <!--background-color:blue;-->
                        <!--<table id="tableforuser" class="table tableresize" style="margin-left:5px;">
                                <tr id="appendforuser">
                                </tr>
                            </table>-->
                        <table id="tableforuser" class="table tableresize" style="color: #022178;">

                            </tr>
                        </table>
                        <!--</div>-->
                    </div>

                </div>
            </div>
        </div>
        <input id="databoolean" class="form-control" style="visibility:hidden" />
        <input id="boolean_makecall" class="form-control" style="visibility:hidden" />
        <!-- /#page-content-wrapper -->

    </div>
    <!-- /#wrapper -->
    <!--<div style="width:12000px;height:200px;background-color:blue;margin-left: 500px;overflow: scroll;">

    </div>-->


    <!-- Bootstrap core JavaScript -->
    <script src="pages/vendor/jquery/jquery.min.js"></script>
    <script src="pages/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script type="/text/javascript" src="pages/scripts/index.js"></script>
    <script type="text/javascript" src="pages/scripts/jquery/jquery-2.1.0.min.js"></script>
    <script type="text/javascript" src="pages/scripts/jquery/jquery.mousewheel.min.js"></script>

    <!-- Menu Toggle Script -->
    <script>
        var stationid = '';
        var callid = '';
        var Mytoken = '';
        var name = 'andy';
        var destinationid = '';
        var secondcount = 0;
        var findata = [];
        var nosound = 1;
        var tatungSpeach = false;
        var flag = false;
        var insearch = false;
        var nowCall = '';
        $(document).ready(function () {
            var displayName = JSON.stringify(mydata.displayName);
            displayName = displayName.replace('"', '').replace('"', '');
            var businessPhones = JSON.stringify(mydata.businessPhones);
            businessPhones = businessPhones.replace('[', '').replace(']', '').replace('"', '').replace('"', '');
            businessPhones = "6407";
            if (businessPhones == null) {
                businessPhones = "無分機";
            }
            if (businessPhones.length > 4) {
                businessPhones = businessPhones.slice(-4);
            }
            $('#loginname').text('您好 ' + displayName + '，您的分機: ' + businessPhones);
            stationid = businessPhones;

        });
        //voiceSearch
        $(document).ready(function () {
            $("#speechStatue").html("開始識別語音...");
            if (!('webkitSpeechRecognition' in window)) {
                alert("這個瀏覽器不支援google語音");
            } else {
                getvoice(false); //1
            }
            $('#voiceSearch').click(function () {
                console.log('voicesearch');
                $(this).attr('disabled', true); //不讓使用者繼續按按鈕
                if (!('webkitSpeechRecognition' in window)) {
                    alert("這個瀏覽器不支援google語音");
                } else {
                    //getvoice(false); //1
                }
            });
        });
        $("#searchdata").keydown(function (event) {
            if (event.which == 13) {
                search();
            }
        });
        var datalength = 0;
        function getvoice(flag) { //1
            console.log("getvoice");
            if (flag != null) tatungSpeach = flag;
            var myTranscript = '';
            var recognition = new webkitSpeechRecognition();
            recognition.continuous = true;
            //如果設定為 true，表示除非我們停止辨識，不然就會一直持續的辨識語音轉換為文字，如果設定為 false，在辨識一段話完成之後就會結束辨識
            recognition.interimResults = false;
            //如果設定為 true，表示在我們講話的當下就會即時辨識，不然就會在一段話結束之後，才會開始辨識。
            recognition.lang = "cmn-Hant-TW";
            recognition.start();
            recognition.onstart = function () {
                console.log('getvoice開始辨識...');
                $("#speechStatue").html("開始識別語音...");
            };
            recognition.onresult = function (event) {
                var i = event.resultIndex;
                var j = event.results[i].length - 1;
                //show.innerHTML = event.results[i][j].transcript;
                console.log(event.results[i][j].transcript)
                console.log('194');
                console.log("tatungSpeach: " + tatungSpeach)
                console.log("insearch: " + insearch)
                console.log('197');
                myTranscript = event.results[i][j].transcript
                recognition.stop();
                $("#speechStatue").html("識別語音中...");
            }
            recognition.onend = function () {
                console.log('getvoice停止辨識!');
                if (myTranscript != "") {
                    if (myTranscript.indexOf('eyny') != -1) {
                        myTranscript = myTranscript.replace('eyny', 'Annie');
                    } else if (myTranscript.indexOf('造字') != -1) {
                        myTranscript = myTranscript.replace('造字', '兆志');
                    } else if (myTranscript.indexOf('自慰') != -1) {
                        myTranscript = myTranscript.replace('自慰', '智偉');
                    } else if (myTranscript.indexOf('之一') != -1) {
                        myTranscript = myTranscript.replace('之一', '志伊');
                    } else if (myTranscript.indexOf('年齡') != -1) {
                        myTranscript = myTranscript.replace('年齡', '連玲');
                    } else if (myTranscript.indexOf('字尾') != -1) {
                        myTranscript = myTranscript.replace('字尾', '智偉');
                    }else if (myTranscript.indexOf('紅') != -1) {
                        myTranscript = myTranscript.replace('紅', '洪');
                    } else if (myTranscript.indexOf('大潤發') != -1) {
                        myTranscript = myTranscript.replace('大潤發', '大同');
                    } else if (myTranscript.indexOf('剪刀子') != -1) {
                        myTranscript = myTranscript.replace('剪刀子', '簡兆智');
                    } else if (myTranscript.indexOf('帶') != -1) {
                        myTranscript = myTranscript.replace('帶', '戴');
                    } else if (myTranscript.indexOf('代孕') != -1) {
                        myTranscript = myTranscript.replace('代孕', '戴筠');
                    } else if (myTranscript.indexOf('大雲') != -1) {
                        myTranscript = myTranscript.replace('大雲', '戴筠');
                    } else if (myTranscript.indexOf('成人') != -1) {
                        myTranscript = myTranscript.replace('成人', '淳仁');
                    } else if (myTranscript.indexOf('大雨') != -1) {
                        myTranscript = myTranscript.replace('大雨', '戴筠');
                    } else if (myTranscript.indexOf('斷腸') != -1) {
                        myTranscript = myTranscript.replace('斷腸', '段淳');
                    } else if (myTranscript.indexOf('和好') != -1) {
                        myTranscript = myTranscript.replace('和好', '何顥');
                    } else if (myTranscript.indexOf('柏旭') != -1) {
                        myTranscript = myTranscript.replace('柏旭', '博旭');
                    } else if (myTranscript.indexOf('剪') != -1) {
                        myTranscript = myTranscript.replace('剪', '簡');
                    } 
                    $('#searchdata').val(myTranscript);
                    var data = {
                        data: myTranscript,
                        tatungSpeach: tatungSpeach
                    };
                    $.post('/tatungSpeach', data, function (res) {
                        console.log(res);
                        if (res == "沒叫我") {
                            console.log('tatungSpeach ' + tatungSpeach);
                            if (tatungSpeach) {
                                $("#searchdata").val(myTranscript);
                                var msg = new SpeechSynthesisUtterance();
                                msg.text = "很抱歉沒有搜尋到資料，請再說一次"; //聽不懂指令喔，
                                speechSynthesis.speak(msg);
                                tatungSpeach = true;
                                msg.onend = function (event) {
                                    console.log('說完 很抱歉沒有搜尋到資料，請再說一次');
                                    getvoice(true);
                                }
                            } else {
                                $("#speechStatue").html("開始識別語音...");
                                console.log("睡覺Ing");
                                $('#searchdata').val('(沒有聽到大同寶寶)');
                                getvoice(false);
                                $('#tableforuser').empty(); //清空appendforuser裡面所有node
                                $('#divrow').width(635);
                            }
                            //recognition.stop();
                        } else if (res == "搜尋") {
                            console.log("進入搜尋");
                            $("#speechStatue").html("搜尋中...");
                            tatungSpeach = true;
                            if (tatungSpeach) {
                                $("#searchdata").val(myTranscript);
                                insearch = true;
                                recognition.stop();
                                search();
                            }
                        } else if (res == "請問有什麼事嗎") {
                            console.log("請問有什麼事嗎");
                            $('#tableforuser').empty(); //清空appendforuser裡面所有node
                            $('#divrow').width(635);
                            $("#searchdata").val(myTranscript);
                            var msg = new SpeechSynthesisUtterance();
                            msg.text = "請問有什麼事嗎";
                            speechSynthesis.speak(msg);
                            tatungSpeach = true;
                            msg.onend = function (event) {
                                console.log('說完 請問有什麼事嗎');
                                getvoice(true);
                            }
                            /*setTimeout(function () {
                                //getvoice();
                                $('#voiceSearch').trigger('click');
                            }, 2000)*/
                        } else if (res == "掰掰") {
                            console.log("沒事別吵我");
                            $("#speechStatue").html("開始識別語音...");
                            $("#searchdata").val('');
                            var msg = new SpeechSynthesisUtterance();
                            msg.text = "再見"; //沒事別吵我
                            speechSynthesis.speak(msg);
                            tatungSpeach = true;
                            msg.onend = function (event) {
                                console.log('說完 掰掰');
                                tatungSpeach = false;
                                getvoice(false);
                            }
                        }
                    })
                } else {
                    getvoice(false);
                }
            };
        }

        function search() { //2
            console.log('function search');
            var searchdata = $('#searchdata').val();
            console.log(searchdata);
            if (searchdata.indexOf('eyny') != -1) {
                searchdata = searchdata.replace('eyny', 'Annie');
            } else if (searchdata.indexOf('造字') != -1) {
                searchdata = searchdata.replace('造字', '兆志');
            } else if (searchdata.indexOf('自慰') != -1) {
                searchdata = searchdata.replace('自慰', '智偉');
            } else if (searchdata.indexOf('之一') != -1) {
                searchdata = searchdata.replace('之一', '志伊');
            } else if (searchdata.indexOf('年齡') != -1) {
                searchdata = searchdata.replace('年齡', '連玲');
            } else if (searchdata.indexOf('字尾') != -1) {
                searchdata = searchdata.replace('字尾', '智偉');
            }else if (searchdata.indexOf('紅') != -1) {
                searchdata = searchdata.replace('紅', '洪');
            } else if (searchdata.indexOf('大潤發') != -1) {
                searchdata = searchdata.replace('大潤發', '大同');
            } else if (searchdata.indexOf('剪刀子') != -1) {
                searchdata = searchdata.replace('剪刀子', '簡兆智');
            } else if (searchdata.indexOf('帶') != -1) {
                searchdata = searchdata.replace('帶', '戴');
            } else if (searchdata.indexOf('代孕') != -1) {
                searchdata = searchdata.replace('代孕', '戴筠');
            } else if (searchdata.indexOf('大雲') != -1) {
                searchdata = searchdata.replace('大雲', '戴筠');
            } else if (searchdata.indexOf('成人') != -1) {
                searchdata = searchdata.replace('成人', '淳仁');
            } else if (searchdata.indexOf('大雨') != -1) {
                searchdata = searchdata.replace('大雨', '戴筠');
            } else if (searchdata.indexOf('斷腸') != -1) {
                searchdata = searchdata.replace('斷腸', '段淳');
            } else if (searchdata.indexOf('和好') != -1) {
                searchdata = searchdata.replace('和好', '何顥');
            } else if (searchdata.indexOf('柏旭') != -1) {
                searchdata = searchdata.replace('柏旭', '博旭');
            } else if (searchdata.indexOf('剪') != -1) {
                searchdata = searchdata.replace('剪', '簡');
            }
            $('#searchdata').val(searchdata);
            var data = {
                searchdata: searchdata
            }
            $.post('/search', data, function (resdata) {
                if (resdata === 'wrong') {
                    //---------------語音---------------
                    var msg = new SpeechSynthesisUtterance();
                    var voices = [];
                    msg.text = "很抱歉沒有搜尋到資料，請再說一次";
                    speechSynthesis.speak(msg);
                    //---------------語音---------------
                    msg.onend = function (event) {
                        console.log('說完 很抱歉沒有搜尋到資料，請再說一次');
                        insearch = false;
                        getvoice(true);
                    }
                    $('#tableforuser').empty(); //清空appendforuser裡面所有node
                    $('#divrow').width(635);
                } else if (resdata === 'cancel') {
                    document.getElementById("voiceSearch").disabled = false;
                    $("#speechStatue").html("開始識別語音...");
                } else {
                    $('#tableforuser').empty(); //清空appendforuser裡面所有node
                    $('#scrollx').animate({
                        scrollLeft: 0
                    }, 200);
                    //.scrollLeft("0"); //把scrollbar拉到最左邊 
                    /*$("#scrollx").mousewheel(function (event, delta) {
                        this.scrollLeft -= (delta * 80);
                        event.preventDefault();
                    });*/
                    resdata = JSON.parse(resdata);
                    findata = resdata; //記錄目前搜尋出來的資料，之後打電話方便搜尋
                    datalength = resdata.length;
                    $('#divrow').width((Math.floor(datalength / 5) + 1) * 635);
                    /*$('#divrow').width(905 * datalength);
                    $('.tableresize').width(905 * datalength);*/
                    for (var i = 0; i < datalength; i++) {
                        if (resdata[i].businessPhones.toString().indexOf('#') != -1) {
                            resdata[i].businessPhones = resdata[i].businessPhones.toString().split('#')[1];
                            resdata[i].businessPhones = resdata[i].businessPhones.toString().replace(/[^0-9]/ig, "");
                        }
                        $('#tableforuser').append(
                            '<tr id="tr' + i +
                            '"><td><img src="/images/tatungba.jpg" class="rounded-circle employeespic" style="margin-right: 4px;"></td><td><h3 style="display: inline">' +
                            (i + 1) + '.' + resdata[i].displayName + '</h3></td>' +
                            '<td><button id="camakecall' + resdata[i].businessPhones +
                            '" type="submit" class="btn newcaserverbtn" onclick="camakecall(' + resdata[
                                i].businessPhones + ')">分機</button><button id="caendcall' + resdata[i].businessPhones +
                            '" type="submit" class="btn newcancelbtn caendcall" onclick="caendcall(' +
                            resdata[i].businessPhones + ')" style="display:none">掛斷</button></td></tr>' //<td><button class="btn newcaserverbtn">手機</button></td>
                        );
                        //$('#userdepart').text('單位:' + resdata.department);
                    }
                    var surname = resdata[0].displayName
                    var givenName = resdata[0].givenName;
                    if (resdata.length < 2) {
                        //---------------語音---------------
                        var msg = new SpeechSynthesisUtterance();
                        var voices = [];
                        msg.text = "以下是搜尋結果，請問幫您撥電話嗎";
                        speechSynthesis.speak(msg);
                        //---------------語音---------------
                        try {
                            msg.onend = function (event) {
                                console.log(JSON.stringify(event));
                                console.log('說完 以下是搜尋結果，請問幫您撥電話嗎');
                                getvoiceSecond();
                            }
                        } catch (err) {
                            console.log(err);
                            msg.onerror = function (event) {
                                console.log(event.error);
                            }
                        }
                    } else {
                        //---------------語音---------------
                        var msg = new SpeechSynthesisUtterance();
                        var voices = [];
                        msg.text = "以下是搜尋結果，要撥給第幾筆資料";
                        speechSynthesis.speak(msg);
                        //---------------語音---------------
                        try {
                            msg.onend = function (event) {
                                console.log(typeof (event));
                                console.log(JSON.stringify(event));
                                console.log('說完 以下是搜尋結果，要撥給第幾筆資料');
                                getvoiceSecond();
                            }
                        } catch (err) {
                            console.log(err);
                            msg.onerror = function (event) {
                                console.log(event.error);
                            }
                        }
                    }
                }
            })
        };

        function getvoiceSecond() { //3
            console.log('getvoiceSecond');
            var myTranscript = '';
            var recognition_forsecond = new webkitSpeechRecognition();
            recognition_forsecond.continuous = false;
            //如果設定為 true，表示除非我們停止辨識，不然就會一直持續的辨識語音轉換為文字，如果設定為 false，在辨識一段話完成之後就會結束辨識
            recognition_forsecond.interimResults = false;
            //如果設定為 true，表示在我們講話的當下就會即時辨識，不然就會在一段話結束之後，才會開始辨識。
            recognition_forsecond.lang = "cmn-Hant-TW";
            recognition_forsecond.onstart = function () {
                console.log('開始辨識...getvoiceSecond');
                $("#speechStatue").html("開始識別語音...");
            };
            recognition_forsecond.onresult = function (event) {
                $("#speechStatue").html("識別語音中...");
                console.log(event)
                var i = event.resultIndex;
                var j = event.results[i].length - 1;
                //show.innerHTML = event.results[i][j].transcript;
                $("#databoolean").val(event.results[i][j].transcript);
                myTranscript = event.results[i][j].transcript;
                recognition_forsecond.stop();
            };
            recognition_forsecond.onend = function () {
                console.log('getvoiceSecond停止辨識!');
                //$("#speechStatue").html("停止識別語音...");
                if (myTranscript == '') {
                    nosound++;
                    if (nosound > 10) {
                        document.getElementById("voiceSearch").disabled = false;
                        $("#speechStatue").html("開始識別語音...");
                        nosound = 1;
                        //---------------語音---------------
                        var msg = new SpeechSynthesisUtterance();
                        var voices = [];
                        msg.text = "我暫離一下，再呼叫我立即回來";
                        speechSynthesis.speak(msg);
                        msg.onend = function (event) {
                            console.log('說完 我暫離一下，再呼叫我立即回來');
                            $('#searchdata').val('(沒有聽到大同寶寶)');
                            insearch = false;
                            getvoice(false);
                        }
                    } else {
                        $("#speechStatue").html("沒有識別到語音...");
                        getvoiceSecond();
                    }
                } else {
                    nosound = 1;
                    var databoolean = $('#databoolean').val();
                    if (databoolean.indexOf('eyny') != -1) {
                        databoolean = databoolean.replace('eyny', 'Annie');
                    } else if (databoolean.indexOf('造字') != -1) {
                        databoolean = databoolean.replace('造字', '兆志');
                    } else if (databoolean.indexOf('自慰') != -1) {
                        databoolean = databoolean.replace('自慰', '智偉');
                    } else if (databoolean.indexOf('之一') != -1) {
                        databoolean = databoolean.replace('之一', '志伊');
                    } else if (databoolean.indexOf('年齡') != -1) {
                        databoolean = databoolean.replace('年齡', '連玲');
                    } else if (databoolean.indexOf('字尾') != -1) {
                        databoolean = databoolean.replace('字尾', '智偉');
                    } else if (databoolean.indexOf('字尾') != -1) {
                        databoolean = databoolean.replace('字尾', '智偉');
                    } else if (databoolean.indexOf('紅') != -1) {
                        databoolean = databoolean.replace('紅', '洪');
                    } else if (databoolean.indexOf('大潤發') != -1) {
                        databoolean = databoolean.replace('大潤發', '大同');
                    } else if (databoolean.indexOf('剪刀子') != -1) {
                        databoolean = databoolean.replace('剪刀子', '簡兆智');
                    } else if (databoolean.indexOf('帶') != -1) {
                        databoolean = databoolean.replace('帶', '戴');
                    } else if (databoolean.indexOf('代孕') != -1) {
                        databoolean = databoolean.replace('代孕', '戴筠');
                    } else if (databoolean.indexOf('大雲') != -1) {
                        databoolean = databoolean.replace('大雲', '戴筠');
                    } else if (databoolean.indexOf('成人') != -1) {
                        databoolean = databoolean.replace('成人', '淳仁');
                    } else if (databoolean.indexOf('大雨') != -1) {
                        databoolean = databoolean.replace('大雨', '戴筠');
                    } else if (databoolean.indexOf('斷腸') != -1) {
                        databoolean = databoolean.replace('斷腸', '段淳');
                    } else if (databoolean.indexOf('和好') != -1) {
                        databoolean = databoolean.replace('和好', '何顥');
                    } else if (databoolean.indexOf('柏旭') != -1) {
                        databoolean = databoolean.replace('柏旭', '博旭');
                    } else if (databoolean.indexOf('剪') != -1) {
                        databoolean = databoolean.replace('剪', '簡');
                    }
                    var data = {
                        databoolean: databoolean
                    }
                    console.log(databoolean);
                    $.post('/databoolean', data, function (resdata) {
                        console.log(Number(resdata))
                        switch (isNaN(resdata) || parseInt(resdata)) {
                            case true:
                                switch (resdata) {
                                    case 'wrong':
                                        $('#searchdata').val(databoolean);
                                        var msg = new SpeechSynthesisUtterance();
                                        var voices = [];
                                        msg.text = "很抱歉沒有搜尋到資料，請再說一次";
                                        speechSynthesis.speak(msg);
                                        //---------------語音---------------
                                        $('#tableforuser').empty(); //清空appendforuser裡面所有node
                                        $('#divrow').width(635);
                                        $('#searchdata').val(databoolean);
                                        msg.onend = function (event) {
                                            console.log('說完 很抱歉沒有搜尋到資料，請再說一次');
                                            insearch = false;
                                            getvoice(true);
                                        }
                                        break;
                                    case 'makecall':
                                        console.log("makecall")
                                        tellyouMakeCall();
                                        var this_businessPhones = JSON.stringify(findata[0].businessPhones);
                                        this_businessPhones = this_businessPhones.replace('[', '').replace(']', '').replace('"', '').replace('"', '');
                                        camakecall(this_businessPhones);
                                        getvoice_HangUp();
                                        $("#speechStatue").html("開始識別語音...");
                                        break;
                                    case 'cancel':
                                    $("#speechStatue").html("開始識別語音...");
                                        document.getElementById("voiceSearch").disabled = false;
                                        insearch = false;
                                        getvoice(false);
                                        break;
                                    case 'bye':
                                    $("#speechStatue").html("開始識別語音...");
                                        document.getElementById("voiceSearch").disabled = false;
                                        $('#searchdata').val('');
                                        insearch = false;
                                        getvoice(false);
                                        break;
                                    case '請問有什麼事嗎':
                                        console.log('請問有什麼事嗎');
                                        $('#tableforuser').empty(); //清空appendforuser裡面所有node
                                        $('#divrow').width(635);
                                        $("#searchdata").val(myTranscript);
                                        var msg = new SpeechSynthesisUtterance();
                                            msg.text = "請問有什麼事嗎";
                                            speechSynthesis.speak(msg);
                                            tatungSpeach = true;
                                            msg.onend = function (event) {
                                            console.log('說完 請問有什麼事嗎');
                                            getvoice(true);
                                        }
                                        break;
                                    default:
                                        console.log("default: " + resdata)
                                        $('#searchdata').val(databoolean);
                                        document.getElementById("getcontacts").click();
                                }
                                break;
                            default:
                                console.log(resdata)
                                tellyouMakeCall();
                                var this_businessPhones = JSON.stringify(findata[Number(resdata) - 1].businessPhones);
                                this_businessPhones = this_businessPhones.replace('[', '').replace(']', '').replace('"', '').replace('"', '');
                                camakecall(this_businessPhones);
                                getvoice_HangUp();
                                $("#speechStatue").html("開始識別語音...");
                                document.getElementById("voiceSearch").disabled = false;
                        }
                    });
                }
            };
            recognition_forsecond.start();
        };


        function getvoice_HangUp() { //4
            console.log('getvoice_HangUp');
            var myTranscript = '';
            var recognition_HangUp = new webkitSpeechRecognition();
            recognition_HangUp.continuous = true;
            //如果設定為 true，表示除非我們停止辨識，不然就會一直持續的辨識語音轉換為文字，如果設定為 false，在辨識一段話完成之後就會結束辨識
            recognition_HangUp.interimResults = true;
            //如果設定為 true，表示在我們講話的當下就會即時辨識，不然就會在一段話結束之後，才會開始辨識。
            recognition_HangUp.lang = "cmn-Hant-TW";
            recognition_HangUp.start();
            recognition_HangUp.onstart = function () {
                console.log('開始辨識...getvoice_HangUp');
                $("#speechStatue").html("開始識別語音...");
            };
            recognition_HangUp.onresult = function (event) {
                console.log(event)
                var i = event.resultIndex;
                var j = event.results[i].length - 1;
                //show.innerHTML = event.results[i][j].transcript;
                myTranscript = event.results[i][j].transcript;
                console.log("通話紀錄: " + myTranscript)
                if ((myTranscript.indexOf("大同寶寶") != -1 || myTranscript.indexOf("大同") != -1 || myTranscript.indexOf("寶寶") != -1)&&
                    (myTranscript.indexOf("掛電話") != -1 || myTranscript.indexOf("掛斷") != -1 || myTranscript.indexOf("掛掉") != -1)) {
                    recognition_HangUp.stop();
                }
            };
            recognition_HangUp.onend = function () {
                console.log('掛斷電號');
                caendcall(nowCall);
            }
        };


        function voiceSearch() {
            var recognition = new webkitSpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;

            recognition.onstart = function () {
                console.log('recognition onstart');
            }
            recognition.onresult = function (event) {
                console.log('recognition onresult');
                var interim_transcript = '';
                var final_transcript = '';

                for (var i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        final_transcript += event.results[i][0].transcript;
                    } else { }
                }
                var text = '';
                if (final_transcript != '') {
                    text += final_transcript;

                }
            }
        };

        function changePhoneNumber(destinationid) {
            if (destinationid.toString().indexOf('#') != -1) {
                destinationid = destinationid.toString().split('#')[1];
            }
            return destinationid.toString().replace(/[^0-9]/ig, "");
        }

        function camakecall(businessPhones) { //撥出電話
            var destinationid = businessPhones;
            console.log(destinationid);
            if (destinationid == null) {
                //do
            } else {
                //getToken(name, password, function (reg) 
                getToken(name, '654321', function (reg) {
                    if (reg.success) {
                        Mytoken = reg.token;
                        $.ajax({
                            "async": true,
                            "crossDomain": true,
                            "url": 'https://tstiticctcstest.herokuapp.com/phone' + '/makecall',
                            //https://tstiticctcstest.herokuapp.com/phone
                            "method": "POST",
                            headers: {
                                'accept': 'application/json',
                                'x-access-token': Mytoken,
                                'Content-Type': 'application/json',
                                'Access-Control-Allow-Origin': "*",
                                /*'Access-Control-Allow-Origin': "*",*/
                                "cache-control": "no-cache"
                            },
                            "processData": false,
                            "data": JSON.stringify({
                                "stationid": stationid,
                                "destinationid": destinationid,
                                "name": name
                            }),
                            success: function (reg) {
                                if (reg.success === false) {
                                    //$('#showtext'+showtext).text("撥號失敗");
                                    console.log('reg.success === false');
                                    setTimeout(function () {
                                        return checkStatus(destinationid)
                                    }, 1000);
                                } else {
                                    console.log('reg.success === true');
                                    //$('#showtext'+showtext).text("正在撥號請等候...");
                                    //延遲一秒function checkStatus()，因為直接跑會出現結束通話狀態，延遲一秒後才會出現撥號中
                                    setTimeout(function () {
                                        return checkStatus(destinationid)
                                    }, 1000);
                                    callid = reg.callid;
                                    return callid;
                                }
                            }
                            /*,complete: function (reg) { //超時
                                                            console.log('complete');
                                                            if (secondcount < 1) {
                                                                secondcount++;
                                                                //$('#showtext'+showtext).text("撥號連線失敗...");
                                                                setTimeout(function () {
                                                                    return checkStatus(destinationid)
                                                                }, 200);
                                                            }
                                                        }*/
                            ,
                            error: function (reg) {
                                console.log('error');
                                console.log(JSON.stringify(reg));
                                if (secondcount < 1) {
                                    secondcount++;
                                    //$('#showtext'+showtext).text("撥號連線失敗...");
                                    setTimeout(function () {
                                        return checkStatus(destinationid)
                                    }, 200);
                                }
                                //$('#makecall').trigger('click');
                            }
                        });
                    } else {
                        alert(reg.message + "........");
                    }
                })
            }
        };

        function caholdcall(businessPhones) { //保留電話
            $.ajax({
                "async": true,
                "crossDomain": true,
                "url": 'https://tstiticctcstest.herokuapp.com/phone' + '/holdcall',
                "method": "POST",
                headers: {
                    'accept': 'application/json',
                    'x-access-token': Mytoken,
                    'Content-Type': 'application/json',
                    "cache-control": "no-cache"
                },
                "processData": false,
                "data": JSON.stringify({
                    "stationid": stationid,
                    "callid": callid,
                    "name": name
                }),
                success: function (reg) {
                    if (reg.success === false) {
                        //$('#showtext').text("保留失敗");
                        $('#caholdcall' + businessPhones).show();
                    } else {
                        setTimeout(function () {
                            return checkStatus(businessPhones)
                        }, 1000);
                    }
                }
            });
        };

        function caretrievecall(businessPhones) { //接回電話
            $.ajax({
                "async": true,
                "crossDomain": true,
                "url": 'https://tstiticctcstest.herokuapp.com/phone' + '/retrievecall',
                "method": "POST",
                headers: {
                    'accept': 'application/json',
                    'x-access-token': Mytoken,
                    'Content-Type': 'application/json',
                    "cache-control": "no-cache"
                },
                "processData": false,
                "data": JSON.stringify({
                    "stationid": stationid,
                    "callid": callid,
                    "name": name
                }),
                success: function (reg) {
                    if (reg.success === false) {
                        //$('#showtext').text("接回失敗");
                        $('#caretrievecall' + businessPhones).show();
                        $('#caendcall' + businessPhones).show();
                    } else {
                        setTimeout(function () {
                            return checkStatus(businessPhones)
                        }, 1000);
                    }
                }
            });
        };

        function caendcall(businessPhones) { //結束電話
            $.ajax({
                "async": true,
                "crossDomain": true,
                "url": 'https://tstiticctcstest.herokuapp.com/phone' + '/endcall',
                "method": "POST",
                headers: {
                    'accept': 'application/json',
                    'x-access-token': Mytoken,
                    'Content-Type': 'application/json',
                    "cache-control": "no-cache"
                },
                "processData": false,
                "data": JSON.stringify({
                    "stationid": stationid,
                    "callid": callid,
                    "name": name
                }),
                success: function (reg) {
                    if (reg.success === false) {
                        //$('#showtext'+showtext).text("掛斷失敗");
                        $('#endcall').show();
                    } else {
                        console.log('endcall');
                        /*setTimeout(function () {
                            return checkStatus(businessPhones)
                        }, 500);*/
                    }
                }
            }); //end post ajax
        };

        function getToken(name, password, callback) {
            $.ajax({
                //url: String(caserverurl).split('/phone')[0] + '/authenticate/login', //https://tstiticctcstest.herokuapp.com/phone
                url: 'https://tstiticctcstest.herokuapp.com/authenticate/login',
                headers: {
                    'accept': 'application/json',
                    'Content-Type': 'application/json',
                    'Access-Control-Allow-Origin': "*",
                    'Access-Control-Allow-Methods': 'GET,PUT,POST,DELETE',
                    'Access-Control-Allow-Headers': 'X-Requested-With, Content-Type'
                },
                type: 'POST',
                data: JSON.stringify({
                    "name": name,
                    "password": password
                }),
                dataType: 'json',
                success: function (reg) {
                    console.log("token資訊: " + JSON.stringify(reg));
                    callback(reg);
                },
                error: function (reg) {
                    //alert("伺服器錯誤..........")
                    alert(JSON.stringify(reg));
                    //return callout(destination);
                }
            });
        }

        function checkStatus(number_id) {
            console.log("checkStatus >......");
            nowCall = number_id;
            $.ajax({
                "async": true,
                "crossDomain": true,
                //"url": caserverurl + '/status/' + name + '?stationid=' + stationid,
                "url": 'https://tstiticctcstest.herokuapp.com/phone' + '/status/' + name + '?stationid=' +
                    stationid,
                "method": "GET",
                headers: {
                    'x-access-token': Mytoken,
                    'Access-Control-Allow-Origin': "*",
                    "cache-control": "no-cache"
                },
                success: function (reg) {
                    if (reg.success === false) {
                        if (reg.message === 'Can not find station status: ' + stationid) {
                            while (secondcount < 1) {
                                secondcount++;
                                setTimeout(function () {
                                    return checkStatus(number_id)
                                }, 1000);
                                // $('#showtext'+showtext).text("");
                            } //end while
                        } else {
                            if (secondcount < 1) {
                                secondcount++;
                                //$('#showtext'+showtext).text("檢查連線中...");
                                //setTimeout(checkStatus,1000);
                                setTimeout(function () {
                                    return checkStatus(number_id)
                                }, 1000);
                            } else {
                                //$('#showtext'+showtext).text("連線失敗!......");
                            }
                        }
                    } else {
                        var callstatus = reg.status.status;
                        callid = reg.status.callid;
                        switch (callstatus) {
                            case "oncallconnect": //通話中
                                $('#camakecall' + number_id).hide();
                                $('#caholdcall' + number_id).show();
                                $('#caretrievecall' + number_id).hide();
                                $('#caendcall' + number_id).show();
                                //$('#showtext'+showtext).text("通話中~");
                                setTimeout(function () {
                                    return checkStatus(number_id)
                                }, 1000);
                                break;
                            case "oncallcreate": //撥號中
                                $('#camakecall' + number_id).hide();
                                $('#caendcall' + number_id).show();
                                //$('#showtext'+showtext).text("撥號中...");
                                setTimeout(function () {
                                    return checkStatus(number_id)
                                }, 1000);
                                break;
                            case "oncallend": //結束
                                $('#camakecall' + number_id).show();
                                $('#caholdcall' + number_id).hide();
                                $('#caretrievecall' + number_id).hide();
                                $('#caendcall' + number_id).hide();
                                insearch = false;
                                getvoice(false)
                                //$('#showtext' + showtext).text("");
                                break;
                            case "oncallhold": //保留中
                                $('#camakecall' + number_id).hide();
                                $('#caendcall' + number_id).show();
                                $('#caretrievecall' + number_id).show();
                                $('#caholdcall' + number_id).hide();
                                //$('#showtext'+showtext).text("保留中...");
                                setTimeout(function () {
                                    return checkStatus(number_id)
                                }, 1000);
                                break;
                            case "oncallring": //響鈴中
                                //do
                                break;
                            default:
                            //do
                        }
                    }
                },
                error: function (reg) {
                    if (name == '' || stationid == '') {
                        //$('#showtext').text("請檢查撥號話機和使用者帳號!");
                    } else {
                        if (secondcount < 1) {
                            secondcount++;
                            //$('#showtext').text("連線錯誤!..........");
                            setTimeout(function () {
                                return checkStatus(number_id)
                            }, 1000);
                        }
                    }
                }
            });

        };
        $(document).ready(function () {
            $('#pagelogout').click(function () {
                alert('尚未完成');
            });
        });


        function tellyouMakeCall() {
            //---------------語音---------------
            var msg = new SpeechSynthesisUtterance();
            var voices = [];
            msg.text = "正在撥打中";
            speechSynthesis.speak(msg);
            insearch = false
            //---------------語音---------------
            /*msg.onend = function (event) {
                console.log('說完 正在撥打中');
                insearch = false;
                getvoice(false);
            }*/

        }
    </script>
</body>

</html>