<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">-->

    <title>歡迎蒞臨大同世界科技</title>

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="pages/vendor/bootstrap/css/bootstrap.css" type="text/css">

    <!-- Custom styles for this template -->
    <link rel="stylesheet" href="pages/css/simple-sidebar.css" type="text/css">

</head>

<body id=indexbody oncontextmenu="return false">
    <!--id=indexbody-->
    <div id="wrapper">
        <!-- Sidebar -->
        <!--<div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <li class="sidebar-brand">
                    <img id="tstipng" src="https://caserverhtmltest.herokuapp.com/images/tstiball.png">
                </li>
                <li>
                    <a href="#">首頁</a>
                </li>
                <li>
                    <a target="_blank" rel="noopener noreferrer" href="https://www.etungo.com.tw/">大同e同購</a>
                </li>
                <li>
                    <a target="_blank" rel="noopener noreferrer" href="https://www.etatung.com/">大同世界科技</a>
                </li>
                <li>
                    <a href="#">Events</a>
                </li>
                <li>
                    <a href="#">About</a>
                </li>
                <li>
                    <a href="#">Services</a>
                </li>
                <li>
                    <a href="#">Contact</a>
                </li>
            </ul>
        </div>-->
        <!-- /#sidebar-wrapper -->
        <div id="pagetop">
            <p id="loginname"></p>
            <!--<p id="pagelogout" style="margin-top: -15px">登出</p>-->
            <!--登出按鈕-->
        </div>
        <!-- Page Content -->
        <div id="page-content-wrapper">
            <div class="container">
                <div class="row">
                    <div style="width:100%;color:#022178;">
                        <h1 style="font-weight:bold;font-size: 52px">歡迎蒞臨大同世界科技</h1>
                        <table style="margin-top:10px">
                            <tr>
                                <td>
                                    <h4>請說出您要找的人名: <input id="voiceSearch" type="button" value="語音查詢" /></h4>
                                </td>
                                <td>
                                    <div id="speechStatue"></div>
                                </td>
                            </tr>
                        </table>
                        <h4 style="margin-top:5px;">或輸入您要找的人名: <input id="searchdata" class="form-control">&nbsp;<button
                                id="getcontacts" type="submit" onclick="search()" style="width:100px;">搜尋</button></h4>
                        <!--class="btn searchbtn"-->
                        <div id="scrollx" style="overflow-x:auto;">
                            <!--margin-left: 120px; margin-top: -25px;-->
                            <div id="divrow" class="row">
                                <!--width:15720px;-->
                                <!--background-color:blue;-->
                                <table id="tableforuser" class="table tableresize" style="margin-left:30px;">
                                    <tr id="appendforuser">
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <input id="databoolean" class="form-control" />
        <input id="boolean_makecall" class="form-control" />
        <!-- /#page-content-wrapper -->

    </div>
    <!-- /#wrapper -->
    <!--<div style="width:12000px;height:200px;background-color:blue;margin-left: 500px;overflow: scroll;">

    </div>-->


    <!-- Bootstrap core JavaScript -->
    <script src="pages/vendor/jquery/jquery.min.js"></script>
    <script src="pages/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script type="/text/javascript" src="pages/scripts/index.js"></script>
    <script type="text/javascript" src="pages/scripts/jquery/jquery-2.1.0.min.js"></script>
    <script type="text/javascript" src="pages/scripts/jquery/jquery.mousewheel.min.js"></script>

    <!-- Menu Toggle Script -->
    <script>
        var stationid = '';
        var callid = '';
        var Mytoken = '';
        var name = 'andy';
        var destinationid = '';
        var secondcount = 0;
        var myvoice = false;
        var findata = [];
        var nosound = 1;
        var tatungSpeach = false;
        var flag = false;
        var insearch = false;
        $(document).ready(function () {
            var displayName = JSON.stringify(mydata.displayName);
            displayName = displayName.replace('"', '').replace('"', '');
            var businessPhones = JSON.stringify(mydata.businessPhones);
            businessPhones = businessPhones.replace('[', '').replace(']', '').replace('"', '').replace('"', '');
            businessPhones = "6303";
            if (businessPhones == null) {
                businessPhones = "無分機";
            }
            if (businessPhones.length > 4) {
                businessPhones = businessPhones.slice(-4);
            }
            $('#loginname').text('您好 ' + displayName + '，您的分機: ' + businessPhones);
            stationid = businessPhones;

        });
        //voiceSearch
        $(document).ready(function () {
            $("#speechStatue").html("點擊\"語音查詢\"開始識別語音，如:請幫我找某某某");
            if (!('webkitSpeechRecognition' in window)) {
                alert("這個瀏覽器不支援google語音");
            } else {
                getvoice(false); //1
            }
            $('#voiceSearch').click(function () {
                console.log('voicesearch');
                $(this).attr('disabled', true); //不讓使用者繼續按按鈕
                if (!('webkitSpeechRecognition' in window)) {
                    alert("這個瀏覽器不支援google語音");
                } else {
                    //getvoice(false); //1
                }
            });
        });
        $("#searchdata").keydown(function (event) {
            if (event.which == 13) {
                search();
            }
        });

        function getvoice(flag) { //1
            console.log("getvoice")
            myvoice = true;
            /*if (flag) tatungSpeach = true;//呼叫大同時修改狀態避免直接大同寶搜尋衝突
            else tatungSpeach = false;*/
            if (flag != null) tatungSpeach = flag;
            var myTranscript = '';
            var recognition = new webkitSpeechRecognition();
            recognition.continuous = true;
            //如果設定為 true，表示除非我們停止辨識，不然就會一直持續的辨識語音轉換為文字，如果設定為 false，在辨識一段話完成之後就會結束辨識
            recognition.interimResults = false;
            //如果設定為 true，表示在我們講話的當下就會即時辨識，不然就會在一段話結束之後，才會開始辨識。
            recognition.lang = "cmn-Hant-TW";
            recognition.start();
            recognition.onstart = function () {
                console.log('開始辨識183...');
                $("#speechStatue").html("開始識別語音...");
            };
            recognition.onresult = function (event) {
                console.log(event)
                var i = event.resultIndex;
                var j = event.results[i].length - 1;
                //show.innerHTML = event.results[i][j].transcript;
                console.log(event.results[i][j].transcript)
                console.log("tatungSpeach: " + tatungSpeach)
                console.log("insearch: " + insearch)
                if (event.results[i][j].transcript != "") {
                    data = {
                        data: event.results[i][j].transcript,
                        tatungSpeach: tatungSpeach
                    };
                    console.log("tatungSpeach: " + tatungSpeach)
                    $.post('/tatungSpeach', data, function (res) {
                        if (res == "沒叫我") {
                            if (tatungSpeach) {
                                var msg = new SpeechSynthesisUtterance();
                                msg.text = "聽不懂指令喔，請再說一次";
                                speechSynthesis.speak(msg);
                                tatungSpeach = true;
                                msg.onend = function (event) {
                                    console.log('說完 聽不懂指令喔，請再說一次');
                                    recognition.stop();
                                }
                            } else
                                console.log("睡覺Ing");
                            //recognition.stop();
                        } else if (res == "搜尋") {
                            console.log("進入搜尋")
                            tatungSpeach = true;
                            if (tatungSpeach) {
                                $("#searchdata").val(event.results[i][j].transcript);
                                myTranscript = event.results[i][j].transcript;
                                insearch = true;
                                recognition.stop();
                                search();
                            }
                        } else if (res == "請問有什麼事嗎") {
                            console.log("請問有什麼事嗎")
                            var msg = new SpeechSynthesisUtterance();
                            msg.text = "請問有什麼事嗎";
                            speechSynthesis.speak(msg);
                            tatungSpeach = true;
                            msg.onend = function (event) {
                                console.log('說完 請問有什麼事嗎');
                                recognition.stop();
                            }
                            /*setTimeout(function () {
                                //getvoice();
                                $('#voiceSearch').trigger('click');
                            }, 2000)*/
                        }
                    })
                }
            }
            recognition.onend = function () {
                console.log('停止辨識!233');
                if (!insearch)
                    getvoice(tatungSpeach)
                /* console.log('insearch: ' + insearch);         
                if (insearch == true) {
                    recognition.start();
                } else {
                    recognition.stop();
                    setTimeout(function () {
                        //recognition.stop();
                        getvoice();
                    }, 1000)
                }
                */
                //$("#speechStatue").html("停止識別語音...");
                /*if (tatungSpeach) {
                    if (myTranscript == '') {
                        nosound++;
                        if (nosound > 5) {
                            document.getElementById("voiceSearch").disabled = false;
                            $("#speechStatue").html("點擊\"語音查詢\"開始識別語音，如:請幫我找某某某");
                            nosound = 1;
                            //---------------語音---------------
                            var msg = new SpeechSynthesisUtterance();
                            var voices = [];
                            msg.text = "請再按一次語音查詢";
                            speechSynthesis.speak(msg);
                            //---------------語音---------------
                            document.getElementById("voiceSearch").disabled = false;
                        } else {
                            //---------------語音---------------
                            var msg = new SpeechSynthesisUtterance();
                            var voices = [];
                            msg.text = "對不起，聲音有點小";
                            speechSynthesis.speak(msg);
                            //---------------語音---------------
                            $("#speechStatue").html("沒有識別到語音...");
                            setTimeout(function () {
                                $('#voiceSearch').trigger('click');
                            }, 2500);
                        }
                    } else {

                        nosound = 1;
                    }
                }*/
            };

            //document.getElementById("getcontacts").click();

            /*setTimeout(function () {
                recognition.stop();
            }, 3000);*/
        }
        /*
        function getvoice() { //1
            myvoice = true;
            var myTranscript = '';
            var recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            //如果設定為 true，表示除非我們停止辨識，不然就會一直持續的辨識語音轉換為文字，如果設定為 false，在辨識一段話完成之後就會結束辨識
            recognition.interimResults = false;
            //如果設定為 true，表示在我們講話的當下就會即時辨識，不然就會在一段話結束之後，才會開始辨識。
            recognition.lang = "cmn-Hant-TW";
            recognition.onstart = function () {
                console.log('開始辨識...');
                $("#speechStatue").html("開始識別語音...");
            };
            recognition.onresult = function (event) {
                console.log(event)
                var i = event.resultIndex;
                var j = event.results[i].length - 1;
                //show.innerHTML = event.results[i][j].transcript;
                $("#searchdata").val(event.results[i][j].transcript);
                myTranscript = event.results[i][j].transcript;
            };
            recognition.onend = function () {
                console.log('停止辨識!');
                //$("#speechStatue").html("停止識別語音...");
                if (myTranscript == '') {
                    nosound++;
                    if (nosound > 5) {
                        document.getElementById("voiceSearch").disabled = false;
                        $("#speechStatue").html("點擊\"語音查詢\"開始識別語音，如:請幫我找某某某");
                        nosound = 1;
                        //---------------語音---------------
                        var msg = new SpeechSynthesisUtterance();
                        var voices = [];
                        msg.text = "請再按一次語音查詢";
                        speechSynthesis.speak(msg);
                        //---------------語音---------------
                        document.getElementById("voiceSearch").disabled = false;
                    } else {
                        //---------------語音---------------
                        var msg = new SpeechSynthesisUtterance();
                        var voices = [];
                        msg.text = "對不起，聲音有點小";
                        speechSynthesis.speak(msg);
                        //---------------語音---------------
                        $("#speechStatue").html("沒有識別到語音...");
                        setTimeout(function () {
                            $('#voiceSearch').trigger('click');
                        }, 2500);
                    }
                } else {
                    document.getElementById("getcontacts").click();
                    nosound = 1;
                }
            };
            recognition.start();
            /*setTimeout(function () {
                recognition.stop();
            }, 3000);
        }
        */
        function getvoiceSecond() { //3
            console.log('Second');
            var myTranscript = '';
            var recognition_forsecond = new webkitSpeechRecognition();
            recognition_forsecond.continuous = false;
            //如果設定為 true，表示除非我們停止辨識，不然就會一直持續的辨識語音轉換為文字，如果設定為 false，在辨識一段話完成之後就會結束辨識
            recognition_forsecond.interimResults = false;
            //如果設定為 true，表示在我們講話的當下就會即時辨識，不然就會在一段話結束之後，才會開始辨識。
            recognition_forsecond.lang = "cmn-Hant-TW";
            recognition_forsecond.onstart = function () {
                console.log('開始辨識...345');
                $("#speechStatue").html("開始識別語音...");
            };
            recognition_forsecond.onresult = function (event) {
                console.log(event)
                var i = event.resultIndex;
                var j = event.results[i].length - 1;
                //show.innerHTML = event.results[i][j].transcript;
                $("#databoolean").val(event.results[i][j].transcript);
                myTranscript = event.results[i][j].transcript;
                recognition_forsecond.stop();
                /*setTimeout(function () {
                    recognition.stop();
                    getvoiceSecond();
                }, 3000);*/
            };
            recognition_forsecond.onend = function () {
                console.log('停止辨識!361');
                //$("#speechStatue").html("停止識別語音...");
                if (myTranscript == '') {
                    nosound++;
                    if (nosound > 10) {
                        document.getElementById("voiceSearch").disabled = false;
                        $("#speechStatue").html("點擊\"語音查詢\"開始識別語音，如:請幫我找某某某");
                        nosound = 1;
                        //---------------語音---------------
                        var msg = new SpeechSynthesisUtterance();
                        var voices = [];
                        msg.text = "我暫離一下，再呼叫我立即回來";
                        speechSynthesis.speak(msg);
                        msg.onend = function (event) {
                            console.log('說完 我暫離一下，再呼叫我立即回來');
                            insearch = false;
                            getvoice(false);
                        }
                        //---------------語音---------------
                        //recognition_forsecond.stop();
                        //tatungSpeach = false;
                        //insearch = false;

                    } else {
                        $("#speechStatue").html("沒有識別到語音...");
                        getvoiceSecond();
                        //setTimeout(getvoiceSecond, 2000);
                    }
                } else {
                    nosound = 1;
                    var databoolean = $('#databoolean').val();
                    var data = {
                        databoolean: databoolean
                    }
                    console.log(databoolean);
                    $.post('/databoolean', data, function (resdata) {
                        if (resdata === 'wrong') {
                            //---------------語音---------------
                            var msg = new SpeechSynthesisUtterance();
                            var voices = [];
                            msg.text = "很抱歉沒有搜尋到資料，請再說一次";
                            speechSynthesis.speak(msg);
                            //---------------語音---------------
                            $('#appendforuser').empty(); //清空appendforuser裡面所有node
                            $('#divrow').width(330);
                            $('#searchdata').val(databoolean);
                            msg.onend = function (event) {
                                console.log('說完 很抱歉沒有搜尋到資料，請再說一次');
                                getvoice(true);
                            }
                            //setTimeout(getvoiceSecond, 3000);
                            /*
                            recognition_forsecond.stop();
                            tatungSpeach = false;
                            insearch = false;
                            setTimeout(function () {
                                $('#voiceSearch').trigger('click');
                            }, 3000)*/
                        } else if (resdata === 'makecall') {
                            tellyouMakeCall();
                            var this_businessPhones = JSON.stringify(findata[0].businessPhones);
                            this_businessPhones = this_businessPhones.replace('[', '').replace(']', '')
                                .replace(
                                    '"', '').replace('"', '');
                            camakecall(this_businessPhones);
                            recognition_forsecond.stop();
                            $("#speechStatue").html("點擊\"語音查詢\"開始識別語音，如:請幫我找某某某");
                            document.getElementById("voiceSearch").disabled = false;
                        } else if (resdata == 'yes') {
                            //---------------語音---------------
                            var msg = new SpeechSynthesisUtterance();
                            var voices = [];
                            msg.text = "很高興能幫到您，需要撥電話嗎";
                            speechSynthesis.speak(msg);
                            //---------------語音---------------
                            msg.onend = function (event) {
                                console.log('說完 很高興能幫到您，需要撥電話嗎');
                                getvoiceThird();
                            }
                            //setTimeout(getvoiceThird, 3000);
                        } else if (resdata == 'cancel') {
                            console.log('cancel');
                            recognition_forsecond.stop();
                            $("#speechStatue").html("點擊\"語音查詢\"開始識別語音，如:請幫我找某某某");
                            document.getElementById("voiceSearch").disabled = false;
                            insearch = false;
                            getvoice(false);
                        } else if (resdata == "1") {
                            tellyouMakeCall();
                            var this_businessPhones = JSON.stringify(findata[0].businessPhones);
                            this_businessPhones = this_businessPhones.replace('[', '').replace(']', '')
                                .replace(
                                    '"', '').replace('"', '');
                            camakecall(this_businessPhones);
                            $("#speechStatue").html("點擊\"語音查詢\"開始識別語音，如:請幫我找某某某");
                            document.getElementById("voiceSearch").disabled = false;
                        } else if (resdata == "2") {
                            tellyouMakeCall();
                            var this_businessPhones = JSON.stringify(findata[1].businessPhones);
                            this_businessPhones = this_businessPhones.replace('[', '').replace(']', '')
                                .replace(
                                    '"', '').replace('"', '');
                            camakecall(this_businessPhones);
                            $("#speechStatue").html("點擊\"語音查詢\"開始識別語音，如:請幫我找某某某");
                            document.getElementById("voiceSearch").disabled = false;
                        } else if (resdata == "3") {
                            tellyouMakeCall();
                            var this_businessPhones = JSON.stringify(findata[2].businessPhones);
                            this_businessPhones = this_businessPhones.replace('[', '').replace(']', '')
                                .replace(
                                    '"', '').replace('"', '');
                            camakecall(this_businessPhones);
                            $("#speechStatue").html("點擊\"語音查詢\"開始識別語音，如:請幫我找某某某");
                            document.getElementById("voiceSearch").disabled = false;
                        } else if (resdata == "4") {
                            tellyouMakeCall();
                            var this_businessPhones = JSON.stringify(findata[3].businessPhones);
                            this_businessPhones = this_businessPhones.replace('[', '').replace(']', '')
                                .replace(
                                    '"', '').replace('"', '');
                            camakecall(this_businessPhones);
                            $("#speechStatue").html("點擊\"語音查詢\"開始識別語音，如:請幫我找某某某");
                            document.getElementById("voiceSearch").disabled = false;
                        } else if (resdata == "5") {
                            tellyouMakeCall();
                            var this_businessPhones = JSON.stringify(findata[4].businessPhones);
                            this_businessPhones = this_businessPhones.replace('[', '').replace(']', '')
                                .replace(
                                    '"', '').replace('"', '');
                            camakecall(this_businessPhones);
                            $("#speechStatue").html("點擊\"語音查詢\"開始識別語音，如:請幫我找某某某");
                            document.getElementById("voiceSearch").disabled = false;
                        } else if (resdata == "6") {
                            tellyouMakeCall();
                            var this_businessPhones = JSON.stringify(findata[5].businessPhones);
                            this_businessPhones = this_businessPhones.replace('[', '').replace(']', '')
                                .replace(
                                    '"', '').replace('"', '');
                            camakecall(this_businessPhones);
                            $("#speechStatue").html("點擊\"語音查詢\"開始識別語音，如:請幫我找某某某");
                            document.getElementById("voiceSearch").disabled = false;
                        } else if (resdata == "7") {
                            tellyouMakeCall();
                            var this_businessPhones = JSON.stringify(findata[6].businessPhones);
                            this_businessPhones = this_businessPhones.replace('[', '').replace(']', '')
                                .replace(
                                    '"', '').replace('"', '');
                            camakecall(this_businessPhones);
                            $("#speechStatue").html("點擊\"語音查詢\"開始識別語音，如:請幫我找某某某");
                            document.getElementById("voiceSearch").disabled = false;
                        } else if (resdata == "8") {
                            tellyouMakeCall();
                            var this_businessPhones = JSON.stringify(findata[7].businessPhones);
                            this_businessPhones = this_businessPhones.replace('[', '').replace(']', '')
                                .replace(
                                    '"', '').replace('"', '');
                            camakecall(this_businessPhones);
                            $("#speechStatue").html("點擊\"語音查詢\"開始識別語音，如:請幫我找某某某");
                            document.getElementById("voiceSearch").disabled = false;
                        } else if (resdata == "9") {
                            tellyouMakeCall();
                            var this_businessPhones = JSON.stringify(findata[8].businessPhones);
                            this_businessPhones = this_businessPhones.replace('[', '').replace(']', '')
                                .replace(
                                    '"', '').replace('"', '');
                            camakecall(this_businessPhones);
                            $("#speechStatue").html("點擊\"語音查詢\"開始識別語音，如:請幫我找某某某");
                            document.getElementById("voiceSearch").disabled = false;
                        } else if (resdata == "10") {
                            tellyouMakeCall();
                            var this_businessPhones = JSON.stringify(findata[9].businessPhones);
                            this_businessPhones = this_businessPhones.replace('[', '').replace(']', '')
                                .replace(
                                    '"', '').replace('"', '');
                            camakecall(this_businessPhones);
                            $("#speechStatue").html("點擊\"語音查詢\"開始識別語音，如:請幫我找某某某");
                            document.getElementById("voiceSearch").disabled = false;
                        } else if (resdata == "11") {
                            tellyouMakeCall();
                            var this_businessPhones = JSON.stringify(findata[10].businessPhones);
                            this_businessPhones = this_businessPhones.replace('[', '').replace(']', '')
                                .replace(
                                    '"', '').replace('"', '');
                            camakecall(this_businessPhones);
                            $("#speechStatue").html("點擊\"語音查詢\"開始識別語音，如:請幫我找某某某");
                            document.getElementById("voiceSearch").disabled = false;
                        } else if (resdata == "12") {
                            tellyouMakeCall();
                            var this_businessPhones = JSON.stringify(findata[11].businessPhones);
                            this_businessPhones = this_businessPhones.replace('[', '').replace(']', '')
                                .replace(
                                    '"', '').replace('"', '');
                            camakecall(this_businessPhones);
                            $("#speechStatue").html("點擊\"語音查詢\"開始識別語音，如:請幫我找某某某");
                            document.getElementById("voiceSearch").disabled = false;
                        } else if (resdata == "13") {
                            tellyouMakeCall();
                            var this_businessPhones = JSON.stringify(findata[12].businessPhones);
                            this_businessPhones = this_businessPhones.replace('[', '').replace(']', '')
                                .replace(
                                    '"', '').replace('"', '');
                            camakecall(this_businessPhones);
                            $("#speechStatue").html("點擊\"語音查詢\"開始識別語音，如:請幫我找某某某");
                            document.getElementById("voiceSearch").disabled = false;
                        } else if (resdata == "14") {
                            tellyouMakeCall();
                            var this_businessPhones = JSON.stringify(findata[13].businessPhones);
                            this_businessPhones = this_businessPhones.replace('[', '').replace(']', '')
                                .replace(
                                    '"', '').replace('"', '');
                            camakecall(this_businessPhones);
                            $("#speechStatue").html("點擊\"語音查詢\"開始識別語音，如:請幫我找某某某");
                            document.getElementById("voiceSearch").disabled = false;
                        } else if (resdata == "15") {
                            tellyouMakeCall();
                            var this_businessPhones = JSON.stringify(findata[14].businessPhones);
                            this_businessPhones = this_businessPhones.replace('[', '').replace(']', '')
                                .replace(
                                    '"', '').replace('"', '');
                            camakecall(this_businessPhones);
                            $("#speechStatue").html("點擊\"語音查詢\"開始識別語音，如:請幫我找某某某");
                            document.getElementById("voiceSearch").disabled = false;
                        } else if (resdata === 'bye') {
                            $("#speechStatue").html("點擊\"語音查詢\"開始識別語音，如:請幫我找某某某");
                            document.getElementById("voiceSearch").disabled = false;
                            $('#searchdata').val('');
                            insearch = false;
                            getvoice(false);
                        } 
                        else {
                            $('#searchdata').val(databoolean);
                            //document.getElementById("getcontacts").click();
                            insearch = false;
                            getvoice(false);
                            return;
                        }
                    });
                }
                /*setTimeout(function () {
                    $("#speechStatue").html("點擊\"語音查詢\"開始識別語音，如:請幫我找某某某");
                }, 3000);*/
            };
            recognition_forsecond.start();
            /*setTimeout(function () {
                recognition_forsecond.stop();
            }, 5000);*/
        };


        function getvoiceThird() { //4
            console.log('Third');
            var myTranscript = '';
            var recognition_forthird = new webkitSpeechRecognition();
            recognition_forthird.continuous = false;
            //如果設定為 true，表示除非我們停止辨識，不然就會一直持續的辨識語音轉換為文字，如果設定為 false，在辨識一段話完成之後就會結束辨識
            recognition_forthird.interimResults = false;
            //如果設定為 true，表示在我們講話的當下就會即時辨識，不然就會在一段話結束之後，才會開始辨識。
            recognition_forthird.lang = "cmn-Hant-TW";
            recognition_forthird.onstart = function () {
                console.log('開始辨識...');
                $("#speechStatue").html("開始識別語音...");
            };
            recognition_forthird.onresult = function (event) {
                console.log(event)
                var i = event.resultIndex;
                var j = event.results[i].length - 1;
                //show.innerHTML = event.results[i][j].transcript;
                $("#boolean_makecall").val(event.results[i][j].transcript);
                myTranscript = event.results[i][j].transcript;
                /*setTimeout(function () {
                    recognition.stop();
                    getvoiceSecond();
                }, 3000);*/
            };
            recognition_forthird.onend = function () {
                console.log('停止辨識!');
                //$("#speechStatue").html("停止識別語音...");
                if (myTranscript == '') {
                    //---------------語音---------------
                    var msg = new SpeechSynthesisUtterance();
                    var voices = [];
                    msg.text = "對不起，聲音有點小";
                    speechSynthesis.speak(msg);
                    //---------------語音---------------
                    $("#speechStatue").html("沒有識別到語音...");
                    setTimeout(getvoiceThird, 2500);
                } else {
                    //document.getElementById("getcontacts").click();
                    //getvoiceSecond();
                    var boolean_makecall = $('#boolean_makecall').val();
                    var data = {
                        boolean_makecall: boolean_makecall
                    }
                    $.post('/boolean_makecall', data, function (resdata) {
                        if (resdata === 'wrong') {
                            $("#speechStatue").html("點擊\"語音查詢\"開始識別語音，如:請幫我找某某某");
                            document.getElementById("voiceSearch").disabled = false;
                        } else {
                            //---------------語音---------------
                            var msg = new SpeechSynthesisUtterance();
                            var voices = [];
                            msg.text = "正在撥打中";
                            speechSynthesis.speak(msg);
                            msg.onend = function (event) {
                                console.log('說完 正在撥打中');
                                insearch = false;
                                getvoice(false);
                            }
                            //---------------語音---------------
                            var this_businessPhones = JSON.stringify(findata[0].businessPhones);
                            this_businessPhones = this_businessPhones.replace('[', '').replace(']', '')
                                .replace(
                                    '"', '').replace('"', '');
                            camakecall(this_businessPhones);
                            $("#speechStatue").html("點擊\"語音查詢\"開始識別語音，如:請幫我找某某某");
                            document.getElementById("voiceSearch").disabled = false;
                        }
                    });
                }
                /*setTimeout(function () {
                    $("#speechStatue").html("點擊\"語音查詢\"開始識別語音，如:請幫我找某某某");
                }, 3000);*/
            };
            recognition_forthird.start();
            /*setTimeout(function () {
                recognition_forthird.stop();
            }, 5000);*/
        };

        function search() { //2
            console.log('function search');
            console.log(myvoice);
            var searchdata = $('#searchdata').val();
            if (searchdata.indexOf('eyny') != -1) {
                searchdata = searchdata.replace('eyny', 'Annie');
                $('#searchdata').val(searchdata);
            } else if (searchdata.indexOf('造字') != -1) {
                searchdata = searchdata.replace('造字', '兆志');
                $('#searchdata').val(searchdata);
            } else if (searchdata.indexOf('自慰') != -1) {
                searchdata = searchdata.replace('自慰', '智偉');
                $('#searchdata').val(searchdata);
            } else if (searchdata.indexOf('之一') != -1) {
                searchdata = searchdata.replace('之一', '志伊');
                $('#searchdata').val(searchdata);
            } else if (searchdata.indexOf('年齡') != -1) {
                searchdata = searchdata.replace('年齡', '連玲');
                $('#searchdata').val(searchdata);
            }
            var data = {
                searchdata: searchdata
            }
            $.post('/search', data, function (resdata) {
                if (resdata === 'wrong') {
                    if (myvoice == true) {
                        //---------------語音---------------
                        var msg = new SpeechSynthesisUtterance();
                        var voices = [];
                        msg.text = "很抱歉沒有搜尋到資料，請再說一次";
                        speechSynthesis.speak(msg);
                        //---------------語音---------------
                        insearch = false;
                        getvoice(true);
                        /*tatungSpeach = false;
                        insearch = false;
                        setTimeout(function () {
                            $('#voiceSearch').trigger('click');
                        }, 3800);*/
                    } else {
                        //---------------語音---------------
                        var msg = new SpeechSynthesisUtterance();
                        var voices = [];
                        msg.text = "很抱歉沒有搜尋到資料，請再試一次";
                        speechSynthesis.speak(msg);
                        //---------------語音---------------
                        insearch = false;
                        getvoice(true);
                    }
                    $('#appendforuser').empty(); //清空appendforuser裡面所有node
                    $('#divrow').width(330);
                } else if (resdata === 'cancel') {
                    document.getElementById("voiceSearch").disabled = false;
                    $("#speechStatue").html("點擊\"語音查詢\"開始識別語音，如:請幫我找某某某");
                } else {
                    myvoice = false;
                    $('#appendforuser').empty(); //清空appendforuser裡面所有node
                    $('#scrollx').animate({
                        scrollLeft: 0
                    }, 200);
                    //.scrollLeft("0"); //把scrollbar拉到最左邊 
                    $("#scrollx").mousewheel(function (event, delta) {

                        this.scrollLeft -= (delta * 80);

                        event.preventDefault();

                    });
                    resdata = JSON.parse(resdata);
                    findata = resdata; //記錄目前搜尋出來的資料，之後打電話方便搜尋
                    var datalength = resdata.length;
                    //resdata[0].businessPhones = 4952;
                    console.log(resdata);
                    /*$('#divrow').width(905 * datalength);
                    $('.tableresize').width(905 * datalength);*/
                    for (var i = 0; i < datalength; i++) {
                        if (resdata[i].businessPhones.toString().indexOf('#') != -1) {
                            resdata[i].businessPhones = resdata[i].businessPhones.toString().split('#')[1];
                            resdata[i].businessPhones = resdata[i].businessPhones.toString().replace(
                                /[^0-9]/ig,
                                "");
                        }
                        /*$('#appendforuser').append(
                            '<td id="newdata">' +
                            '<table class="table table-bordered">' +
                            '<tr>' +
                            '<td class="tdresize">' +
                            '<img src="/images/tatungba.jpg" class="rounded-circle img-fluid d-block employeespic"><br/>' +
                            '<h3 style="text-align:center">第' + (i + 1) + '筆資料</h3>' +
                            '</td>' +
                            '<td>' +
                            '<table class="table table-bordered">' +
                            '<tr>' +
                            '<td><h3>姓名:' + resdata[i].displayName + '</h3>' +
                            '</td>' +
                            '</tr>' +
                            '<tr>' +
                            '<td><h3>信箱:' + resdata[i].mail + '</h3>' +
                            '</td>' +
                            '</tr>' +
                            '<tr>' +
                            '<td><span><button id="camakecall' + resdata[i].businessPhones +
                            '" type="submit" class="btn caserverbtn" onclick="camakecall(' + resdata[i].businessPhones +
                            ')">桌上電話<br/>' + resdata[i].businessPhones + '</button>&nbsp;' +
                            '<button id="caendcall' + resdata[i].businessPhones +
                            '" type="submit" class="btn caserverbtnred caendcall" onclick="caendcall(' +
                            resdata[i].businessPhones + ')" style="display:none">掛斷電話</button>&nbsp;' +
                            '<button id="mobilemakecall"+ type="submit" class="btn caserverbtn">行動電話<br/>' +
                            resdata[i].mobilePhone +
                            '</button></span></td>' +
                            '</tr>' +
                            '</table>' +
                            '</td>' +
                            '</tr>' +
                            '</table>' +
                            '</td>'
                        );*/
                        if ((i + 1) <= 5) {
                            $('#appendforuser').append(
                                '<span><img src="/images/tatungba.jpg" class="rounded-circle employeespic" style="margin-right: 4px;"><h3 style="display: inline">' +
                                (i + 1) + '.' + resdata[i].displayName + '</h3>&nbsp;' +
                                '<button id="camakecall' + resdata[i].businessPhones +
                                '" type="submit" class="btn newcaserverbtn" onclick="camakecall(' +
                                resdata[
                                    i].businessPhones + ')">分機</button><button id="caendcall' + resdata[
                                    i].businessPhones +
                                '" type="submit" class="btn newcancelbtn caendcall" onclick="caendcall(' +
                                resdata[i].businessPhones +
                                ')" style="display:none">掛斷</button>&nbsp;<button class="btn newcaserverbtn">手機</button></span><br/>'
                            );
                        }

                        //$('#userdepart').text('單位:' + resdata.department);
                    }
                    var surname = resdata[0].displayName
                    var givenName = resdata[0].givenName;
                    if (resdata.length < 2) {
                        //---------------語音---------------
                        var msg = new SpeechSynthesisUtterance();
                        var voices = [];
                        msg.text = "以下是搜尋結果，請問幫您撥電話嗎" /*"請問您是找" + surname + '嗎'*/ ;
                        speechSynthesis.speak(msg);
                        //---------------語音---------------
                        msg.onend = function (event) {
                            console.log('說完 以下是搜尋結果，請問幫您撥電話嗎');
                            getvoiceSecond();
                        }
                        //setTimeout(getvoiceSecond, 3300); //3
                    } else {
                        //---------------語音---------------
                        var msg = new SpeechSynthesisUtterance();
                        var voices = [];
                        msg.text = "以下是搜尋結果，要撥給第幾筆資料" /*"請問您是找" + surname + '嗎，或者有找到您要的人嗎'*/ ;
                        speechSynthesis.speak(msg);
                        //---------------語音---------------
                        msg.onend = function (event) {
                            console.log('說完 以下是搜尋結果，要撥給第幾筆資料');
                            getvoiceSecond();
                        }
                        //setTimeout(getvoiceSecond, 3300); //3
                    }

                    /*setTimeout(function () {
                        //---------------語音---------------
                        var msg = new SpeechSynthesisUtterance();
                        var voices = [];
                        msg.text = "對不起，我暫離一下，再按語音查詢即可找到我哦";
                        speechSynthesis.speak(msg);
                        //---------------語音---------------
                    }, 300000);*/
                }
            })
        };

        function voiceSearch() {
            var recognition = new webkitSpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;

            recognition.onstart = function () {
                console.log('recognition onstart');
            }
            recognition.onresult = function (event) {
                console.log('recognition onresult');
                var interim_transcript = '';
                var final_transcript = '';

                for (var i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        final_transcript += event.results[i][0].transcript;
                    } else {}
                }
                var text = '';
                if (final_transcript != '') {
                    text += final_transcript;

                }
            }
        };

        function changePhoneNumber(destinationid) {
            if (destinationid.toString().indexOf('#') != -1) {
                destinationid = destinationid.toString().split('#')[1];
            }
            return destinationid.toString().replace(/[^0-9]/ig, "");
        }

        function camakecall(businessPhones) { //撥出電話
            var destinationid = businessPhones;
            console.log(destinationid);
            if (destinationid == null) {
                //do
            } else {
                //getToken(name, password, function (reg) 
                getToken(name, '654321', function (reg) {
                    if (reg.success) {
                        Mytoken = reg.token;
                        $.ajax({
                            "async": true,
                            "crossDomain": true,
                            "url": 'https://tstiticctcstest.herokuapp.com/phone' + '/makecall',
                            //https://tstiticctcstest.herokuapp.com/phone
                            "method": "POST",
                            headers: {
                                'accept': 'application/json',
                                'x-access-token': Mytoken,
                                'Content-Type': 'application/json',
                                'Access-Control-Allow-Origin': "*",
                                /*'Access-Control-Allow-Origin': "*",*/
                                "cache-control": "no-cache"
                            },
                            "processData": false,
                            "data": JSON.stringify({
                                "stationid": stationid,
                                "destinationid": destinationid,
                                "name": name
                            }),
                            success: function (reg) {
                                    if (reg.success === false) {
                                        //$('#showtext'+showtext).text("撥號失敗");
                                        console.log('reg.success === false');
                                        setTimeout(function () {
                                            return checkStatus(destinationid)
                                        }, 1000);
                                    } else {
                                        console.log('reg.success === true');
                                        //$('#showtext'+showtext).text("正在撥號請等候...");
                                        //延遲一秒function checkStatus()，因為直接跑會出現結束通話狀態，延遲一秒後才會出現撥號中
                                        setTimeout(function () {
                                            return checkStatus(destinationid)
                                        }, 1000);
                                        callid = reg.callid;
                                        return callid;
                                    }
                                }
                                /*,complete: function (reg) { //超時
                                                                console.log('complete');
                                                                if (secondcount < 1) {
                                                                    secondcount++;
                                                                    //$('#showtext'+showtext).text("撥號連線失敗...");
                                                                    setTimeout(function () {
                                                                        return checkStatus(destinationid)
                                                                    }, 200);
                                                                }
                                                            }*/
                                ,
                            error: function (reg) {
                                console.log('error');
                                console.log(JSON.stringify(reg));
                                if (secondcount < 1) {
                                    secondcount++;
                                    //$('#showtext'+showtext).text("撥號連線失敗...");
                                    setTimeout(function () {
                                        return checkStatus(destinationid)
                                    }, 200);
                                }
                                //$('#makecall').trigger('click');
                            }
                        });
                    } else {
                        alert(reg.message + "........");
                    }
                })
            }
        };

        function caholdcall(businessPhones) { //保留電話
            $.ajax({
                "async": true,
                "crossDomain": true,
                "url": 'https://tstiticctcstest.herokuapp.com/phone' + '/holdcall',
                "method": "POST",
                headers: {
                    'accept': 'application/json',
                    'x-access-token': Mytoken,
                    'Content-Type': 'application/json',
                    "cache-control": "no-cache"
                },
                "processData": false,
                "data": JSON.stringify({
                    "stationid": stationid,
                    "callid": callid,
                    "name": name
                }),
                success: function (reg) {
                    if (reg.success === false) {
                        //$('#showtext').text("保留失敗");
                        $('#caholdcall' + businessPhones).show();
                    } else {
                        setTimeout(function () {
                            return checkStatus(businessPhones)
                        }, 1000);
                    }
                }
            });
        };

        function caretrievecall(businessPhones) { //接回電話
            $.ajax({
                "async": true,
                "crossDomain": true,
                "url": 'https://tstiticctcstest.herokuapp.com/phone' + '/retrievecall',
                "method": "POST",
                headers: {
                    'accept': 'application/json',
                    'x-access-token': Mytoken,
                    'Content-Type': 'application/json',
                    "cache-control": "no-cache"
                },
                "processData": false,
                "data": JSON.stringify({
                    "stationid": stationid,
                    "callid": callid,
                    "name": name
                }),
                success: function (reg) {
                    if (reg.success === false) {
                        //$('#showtext').text("接回失敗");
                        $('#caretrievecall' + businessPhones).show();
                        $('#caendcall' + businessPhones).show();
                    } else {
                        setTimeout(function () {
                            return checkStatus(businessPhones)
                        }, 1000);
                    }
                }
            });
        };

        function caendcall(businessPhones) { //結束電話
            $.ajax({
                "async": true,
                "crossDomain": true,
                "url": 'https://tstiticctcstest.herokuapp.com/phone' + '/endcall',
                "method": "POST",
                headers: {
                    'accept': 'application/json',
                    'x-access-token': Mytoken,
                    'Content-Type': 'application/json',
                    "cache-control": "no-cache"
                },
                "processData": false,
                "data": JSON.stringify({
                    "stationid": stationid,
                    "callid": callid,
                    "name": name
                }),
                success: function (reg) {
                    if (reg.success === false) {
                        //$('#showtext'+showtext).text("掛斷失敗");
                        $('#endcall').show();
                    } else {
                        console.log('endcall');
                        /*setTimeout(function () {
                            return checkStatus(businessPhones)
                        }, 500);*/
                    }
                }
            }); //end post ajax
        };

        function getToken(name, password, callback) {
            $.ajax({
                //url: String(caserverurl).split('/phone')[0] + '/authenticate/login', //https://tstiticctcstest.herokuapp.com/phone
                url: 'https://tstiticctcstest.herokuapp.com/authenticate/login',
                headers: {
                    'accept': 'application/json',
                    'Content-Type': 'application/json',
                    'Access-Control-Allow-Origin': "*",
                    'Access-Control-Allow-Methods': 'GET,PUT,POST,DELETE',
                    'Access-Control-Allow-Headers': 'X-Requested-With, Content-Type'
                },
                type: 'POST',
                data: JSON.stringify({
                    "name": name,
                    "password": password
                }),
                dataType: 'json',
                success: function (reg) {
                    console.log("token資訊: " + JSON.stringify(reg));
                    callback(reg);
                },
                error: function (reg) {
                    //alert("伺服器錯誤..........")
                    alert(JSON.stringify(reg));
                    //return callout(destination);
                }
            });
        }

        function checkStatus(number_id) {
            console.log("checkStatus >......");
            $.ajax({
                "async": true,
                "crossDomain": true,
                //"url": caserverurl + '/status/' + name + '?stationid=' + stationid,
                "url": 'https://tstiticctcstest.herokuapp.com/phone' + '/status/' + name + '?stationid=' +
                    stationid,
                "method": "GET",
                headers: {
                    'x-access-token': Mytoken,
                    'Access-Control-Allow-Origin': "*",
                    "cache-control": "no-cache"
                },
                success: function (reg) {
                    if (reg.success === false) {
                        if (reg.message === 'Can not find station status: ' + stationid) {
                            while (secondcount < 1) {
                                secondcount++;
                                setTimeout(function () {
                                    return checkStatus(number_id)
                                }, 1000);
                                // $('#showtext'+showtext).text("");
                            } //end while
                        } else {
                            if (secondcount < 1) {
                                secondcount++;
                                //$('#showtext'+showtext).text("檢查連線中...");
                                //setTimeout(checkStatus,1000);
                                setTimeout(function () {
                                    return checkStatus(number_id)
                                }, 1000);
                            } else {
                                //$('#showtext'+showtext).text("連線失敗!......");
                            }
                        }
                    } else {
                        var callstatus = reg.status.status;
                        callid = reg.status.callid;
                        switch (callstatus) {
                            case "oncallconnect": //通話中
                                $('#camakecall' + number_id).hide();
                                $('#caholdcall' + number_id).show();
                                $('#caretrievecall' + number_id).hide();
                                $('#caendcall' + number_id).show();
                                //$('#showtext'+showtext).text("通話中~");
                                setTimeout(function () {
                                    return checkStatus(number_id)
                                }, 1000);
                                break;
                            case "oncallcreate": //撥號中
                                $('#camakecall' + number_id).hide();
                                $('#caendcall' + number_id).show();
                                //$('#showtext'+showtext).text("撥號中...");
                                setTimeout(function () {
                                    return checkStatus(number_id)
                                }, 1000);
                                break;
                            case "oncallend": //結束
                                $('#camakecall' + number_id).show();
                                $('#caholdcall' + number_id).hide();
                                $('#caretrievecall' + number_id).hide();
                                $('#caendcall' + number_id).hide();
                                //tatungSpeach = false;
                                //insearch = false;
                                getvoice(false);
                                //$('#showtext' + showtext).text("");
                                break;
                            case "oncallhold": //保留中
                                $('#camakecall' + number_id).hide();
                                $('#caendcall' + number_id).show();
                                $('#caretrievecall' + number_id).show();
                                $('#caholdcall' + number_id).hide();
                                //$('#showtext'+showtext).text("保留中...");
                                setTimeout(function () {
                                    return checkStatus(number_id)
                                }, 1000);
                                break;
                            case "oncallring": //響鈴中
                                //do
                                break;
                            default:
                                //do
                        }
                    }
                },
                error: function (reg) {
                    if (name == '' || stationid == '' || caserverurl == '') {
                        //$('#showtext').text("請檢查撥號話機和使用者帳號!");
                    } else {
                        if (secondcount < 1) {
                            secondcount++;
                            //$('#showtext').text("連線錯誤!..........");
                            setTimeout(function () {
                                return checkStatus(number_id)
                            }, 1000);
                        }
                    }
                }
            });

        };
        $(document).ready(function () {
            $('#pagelogout').click(function () {
                alert('尚未完成');
            });
        });


        function tellyouMakeCall() {
            //---------------語音---------------
            var msg = new SpeechSynthesisUtterance();
            var voices = [];
            msg.text = "正在撥打中";
            speechSynthesis.speak(msg);
            insearch = false
            //---------------語音---------------
            /*msg.onend = function (event) {
                console.log('說完 正在撥打中');
                insearch = false;
                getvoice(false);
            }*/

        }
    </script>
</body>

</html>