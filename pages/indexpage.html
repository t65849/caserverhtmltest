<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">-->

    <title>歡迎蒞臨大同世界科技</title>

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="/vendor/bootstrap/css/bootstrap.css" type="text/css">

    <!-- Custom styles for this template -->
    <link rel="stylesheet" href="/css/simple-sidebar.css" type="text/css">

</head>

<body id=indexbody><!--id=indexbody-->
    <div id="wrapper">
        <!-- Sidebar -->
        <!--<div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <li class="sidebar-brand">
                    <img id="tstipng" src="https://caserverhtmltest.herokuapp.com/images/tstiball.png">
                </li>
                <li>
                    <a href="#">首頁</a>
                </li>
                <li>
                    <a target="_blank" rel="noopener noreferrer" href="https://www.etungo.com.tw/">大同e同購</a>
                </li>
                <li>
                    <a target="_blank" rel="noopener noreferrer" href="https://www.etatung.com/">大同世界科技</a>
                </li>
                <li>
                    <a href="#">Events</a>
                </li>
                <li>
                    <a href="#">About</a>
                </li>
                <li>
                    <a href="#">Services</a>
                </li>
                <li>
                    <a href="#">Contact</a>
                </li>
            </ul>
        </div>-->
        <!-- /#sidebar-wrapper -->
        <div id="pagetop">
            <p id="loginname"></p>
            <!--<p id="pagelogout" style="margin-top: -15px">登出</p>-->  <!--登出按鈕-->
        </div>
        <!-- Page Content -->
        <div id="page-content-wrapper">
            <div class="container">
                <div class="row">
                    <div style="width:800px;color:#5e555e;">
                        <h1>歡迎蒞臨大同世界科技</h1>
                        <table>
                            <tr>
                                <td>
                                    <h5>請說出您要找的人名: <input id="voiceSearch" type="button" value="語音查詢" /></h5>
                                </td>
                                <td>
                                    <div id="speechStatue"></div>
                                </td>
                            </tr>
                        </table>
                        <h5>或輸入您要找的人名: <input id="searchdata" class="form-control" onkeypress="keysearch()"><button id="getcontacts"
                                type="submit" class="btn searchbtn" onclick="search()">搜尋</button></h5>
                    </div>
                </div>
            </div>
        </div>
        <!-- /#page-content-wrapper -->

    </div>
    <!-- /#wrapper -->
    <!--<div style="width:12000px;height:200px;background-color:blue;margin-left: 500px;overflow: scroll;">

    </div>-->
    <div style="overflow-x:auto;margin-left: 170px">
        <div id="divrow" class="row" style="height:455px; width: 330px;">
            <!--width:15720px;-->
            <!--background-color:blue;-->
            <table class="table table-bordered tableresize" style="margin-left:30px;">
                <tr id="appendforuser">
                </tr>
            </table>
        </div>
    </div>

    <!-- Bootstrap core JavaScript -->
    <script src="/vendor/jquery/jquery.min.js"></script>
    <script src="/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script type="/text/javascript" src="/scripts/index.js"></script>
    <script type="text/javascript" src="/scripts/jquery/jquery-2.1.0.min.js"></script>

    <!-- Menu Toggle Script -->
    <script>
        var stationid = '';
        var callid = '';
        var Mytoken = '';
        var name = 'andy';
        var destinationid = '';
        var secondcount = 0;
        $(document).ready(function () {
            var displayName = JSON.stringify(mydata.displayName);
            displayName = displayName.replace('"', '').replace('"', '');
            var businessPhones = JSON.stringify(mydata.businessPhones);
            businessPhones = businessPhones.replace('[', '').replace(']', '').replace('"', '').replace('"', '');
            businessPhones = "6303";
            if (businessPhones == null) {
                businessPhones = "無分機";
            }
            if (businessPhones.length > 4) {
                businessPhones = businessPhones.slice(-4);
            }
            $('#loginname').text('您好 ' + displayName + '，您的分機: ' + businessPhones);
            stationid = businessPhones;

        });
        //voiceSearch
        $(document).ready(function () {
            $("#speechStatue").html("點擊\"語音查詢\"開始識別語音...");
            $('#voiceSearch').click(function () {
                if (!('webkitSpeechRecognition' in window)) {
                    alert("這個瀏覽器不支援google語音")
                } else {
                    var myTranscript = '';
                    var recognition = new webkitSpeechRecognition();
                    recognition.continuous = true;
                    //如果設定為 true，表示除非我們停止辨識，不然就會一直持續的辨識語音轉換為文字，如果設定為 false，在辨識一段話完成之後就會結束辨識
                    recognition.interimResults = true;
                    //如果設定為 true，表示在我們講話的當下就會即時辨識，不然就會在一段話結束之後，才會開始辨識。
                    recognition.lang = "cmn-Hant-TW";
                    recognition.onstart = function () {
                        console.log('開始辨識...');
                        $("#speechStatue").html("開始識別語音...");
                    };
                    recognition.onend = function () {
                        console.log('停止辨識!');
                        $("#speechStatue").html("停止識別語音...");
                        if (myTranscript == '') {
                            $("#speechStatue").html("沒有識別到語音...");
                        } else {
                            document.getElementById("getcontacts").click();
                        }
                        setTimeout(function () {
                            $("#speechStatue").html("點擊\"語音查詢\"開始識別語音...");
                        }, 3000);
                    };
                    recognition.start();
                    recognition.onresult = function (event) {
                        console.log(event)
                        var i = event.resultIndex;
                        var j = event.results[i].length - 1;
                        //show.innerHTML = event.results[i][j].transcript;
                        $("#searchdata").val(event.results[i][j].transcript);
                        myTranscript = event.results[i][j].transcript;
                        setTimeout(function () {
                            recognition.stop();
                        }, 3000);
                    };
                }
            });
        });

        function search() {
            var searchdata = $('#searchdata').val();
            var data = {
                searchdata: searchdata
            }
            $.post('/search', data, function (resdata) {
                if (resdata === 'wrong') {
                    alert('查無資料');
                    $('#appendforuser').empty(); //清空appendforuser裡面所有node
                    $('#divrow').width(330);
                } else {
                    $('#appendforuser').empty(); //清空appendforuser裡面所有node
                    resdata = JSON.parse(resdata);
                    var datalength = resdata.length;
                    //resdata[0].businessPhones = 4952;
                    console.log(resdata);
                    $('#divrow').width(775 * datalength);
                    $('.tableresize').width(775 * datalength);
                    for (var i = 0; i < datalength; i++) {
                        $('#appendforuser').append(
                            '<td id="newdata">' +
                            '<table class="table table-bordered">' +
                            '<tr>' +
                            '<td class="tdresize">' +
                            '<img src="/images/tatungba.jpg" class="rounded-circle img-fluid d-block employeespic">' +
                            '</td>' +
                            '<td>' +
                            '<table class="table table-bordered">' +
                            '<tr>' +
                            '<td><h3>姓名:' + resdata[i].displayName + '<h3>' +
                            '</td>' +
                            '</tr>' +
                            '<tr>' +
                            '<td><h3>信箱:' + resdata[i].mail + '</h3>' +
                            '</td>' +
                            '</tr>' +
                            '<tr>' +
                            '<td><button id="camakecall' + resdata[i].businessPhones +
                            '" type="submit" class="btn caserverbtn" onclick="camakecall(' + resdata[i].businessPhones +
                            ')">撥打桌上電話' + resdata[i].businessPhones + '</button>' + //4952 == resdata[i].businessPhones
                            '<button id="caholdcall' + resdata[i].businessPhones +
                            '" type="submit" class="btn caserverbtn" onclick="caholdcall(' + resdata[i].businessPhones +
                            ')" style="display:none">保留電話</button>' +
                            '<button id="caretrievecall' + resdata[i].businessPhones +
                            '" type="submit" class="btn caserverbtn" onclick="caretrievecall(' + resdata[i]
                            .businessPhones + ')" style="display:none">接回電話</button>' +
                            '<button id="caendcall' + resdata[i].businessPhones +
                            '" type="submit" class="btn caserverbtn caendcall" onclick="caendcall(' +
                            resdata[i].businessPhones + ')" style="display:none">掛斷電話</button>' +
                            '<p id="showtext'+resdata[i].businessPhones+'"></p>' +
                            '</td>' +
                            '</tr>' +
                            '<tr>' +
                            ' <td><button type="submit" class="btn caserverbtn">撥打行動電話' + resdata[i].mobilePhone +
                            '</button></td>' +
                            '</tr>' +
                            '</table>' +
                            '</td>' +
                            '</tr>' +
                            '</table>' +
                            '</td>'
                        );
                        //$('#userdepart').text('單位:' + resdata.department);
                    }
                }
            })
        };

        function voiceSearch() {
            var recognition = new webkitSpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;

            recognition.onstart = function () {
                console.log('recognition onstart');
            }
            recognition.onresult = function (event) {
                console.log('recognition onresult');
                var interim_transcript = '';
                var final_transcript = '';

                for (var i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        final_transcript += event.results[i][0].transcript;
                    } else {}
                }
                var text = '';
                if (final_transcript != '') {
                    text += final_transcript;

                }
            }
        };

        function camakecall(businessPhones) { //撥出電話
            var destinationid = businessPhones;
            if (destinationid == null) {
                //do
            } else {
                //getToken(name, password, function (reg) 
                getToken(name, '654321', function (reg) {
                    if (reg.success) {
                        Mytoken = reg.token;
                        $.ajax({
                            "async": true,
                            "crossDomain": true,
                            "url": 'https://tstiticctcstest.herokuapp.com/phone' + '/makecall',
                            //https://tstiticctcstest.herokuapp.com/phone
                            "method": "POST",
                            headers: {
                                'accept': 'application/json',
                                'x-access-token': Mytoken,
                                'Content-Type': 'application/json',
                                'Access-Control-Allow-Origin': "*",
                                "cache-control": "no-cache"
                            },
                            "processData": false,
                            "data": JSON.stringify({
                                "stationid": stationid,
                                "destinationid": destinationid,
                                "name": name
                            }),
                            success: function (reg) {
                                checkStatus(destinationid);
                                if (reg.success === false) {
                                    $('#showtext'+showtext).text("撥號失敗");
                                    setTimeout(function () {
                                        return checkStatus(destinationid)
                                    }, 1000);
                                } else {
                                    $('#showtext'+showtext).text("正在撥號請等候...");
                                    //延遲一秒function checkStatus()，因為直接跑會出現結束通話狀態，延遲一秒後才會出現撥號中
                                    setTimeout(function () {
                                        return checkStatus(destinationid)
                                    }, 1000);
                                    callid = reg.callid;
                                    return callid;
                                }
                            },
                            error: function (reg) {
                                console.log('----------------------------------------------------------------------------------------------------');
                                console.log(JSON.stringify(reg));
                                console.log('----------------------------------------------------------------------------------------------------');
                                if (secondcount < 1) {
                                    secondcount++;
                                    $('#showtext'+showtext).text("撥號連線失敗...");
                                    setTimeout(function () {
                                        return checkStatus(destinationid)
                                    }, 200);
                                }
                                //$('#makecall').trigger('click');
                            }
                        });
                    } else {
                        alert(reg.message + "........");
                    }
                })
            }
        };

        function caholdcall(businessPhones) { //保留電話
            $.ajax({
                "async": true,
                "crossDomain": true,
                "url": 'https://tstiticctcstest.herokuapp.com/phone' + '/holdcall',
                "method": "POST",
                headers: {
                    'accept': 'application/json',
                    'x-access-token': Mytoken,
                    'Content-Type': 'application/json',
                    "cache-control": "no-cache"
                },
                "processData": false,
                "data": JSON.stringify({
                    "stationid": stationid,
                    "callid": callid,
                    "name": name
                }),
                success: function (reg) {
                    if (reg.success === false) {
                        $('#showtext').text("保留失敗");
                        $('#caholdcall' + businessPhones).show();
                    } else {
                        setTimeout(function () {
                            return checkStatus(businessPhones)
                        }, 1000);
                    }
                }
            });
        };

        function caretrievecall(businessPhones) { //接回電話
            $.ajax({
                "async": true,
                "crossDomain": true,
                "url": 'https://tstiticctcstest.herokuapp.com/phone' + '/retrievecall',
                "method": "POST",
                headers: {
                    'accept': 'application/json',
                    'x-access-token': Mytoken,
                    'Content-Type': 'application/json',
                    "cache-control": "no-cache"
                },
                "processData": false,
                "data": JSON.stringify({
                    "stationid": stationid,
                    "callid": callid,
                    "name": name
                }),
                success: function (reg) {
                    if (reg.success === false) {
                        $('#showtext').text("接回失敗");
                        $('#caretrievecall' + businessPhones).show();
                        $('#caendcall' + businessPhones).show();
                    } else {
                        setTimeout(function () {
                            return checkStatus(businessPhones)
                        }, 1000);
                    }
                }
            });
        };

        function caendcall(businessPhones) { //結束電話
            $.ajax({
                "async": true,
                "crossDomain": true,
                "url": 'https://tstiticctcstest.herokuapp.com/phone' + '/endcall',
                "method": "POST",
                headers: {
                    'accept': 'application/json',
                    'x-access-token': Mytoken,
                    'Content-Type': 'application/json',
                    "cache-control": "no-cache"
                },
                "processData": false,
                "data": JSON.stringify({
                    "stationid": stationid,
                    "callid": callid,
                    "name": name
                }),
                success: function (reg) {
                    if (reg.success === false) {
                        $('#showtext'+showtext).text("掛斷失敗");
                        $('#endcall').show();
                    } else {
                        checkStatus(businessPhones);
                    }
                }
            }); //end post ajax
        };

        function getToken(name, password, callback) {
            $.ajax({
                //url: String(caserverurl).split('/phone')[0] + '/authenticate/login', //https://tstiticctcstest.herokuapp.com/phone
                url: 'https://tstiticctcstest.herokuapp.com/authenticate/login',
                headers: {
                    'accept': 'application/json',
                    'Content-Type': 'application/json',
                    'Access-Control-Allow-Origin': "*",
                    'Access-Control-Allow-Methods': 'GET,PUT,POST,DELETE',
                    'Access-Control-Allow-Headers': 'X-Requested-With, Content-Type'
                },
                type: 'POST',
                data: JSON.stringify({
                    "name": name,
                    "password": password
                }),
                dataType: 'json',
                success: function (reg) {
                    console.log("token資訊: " + JSON.stringify(reg));
                    callback(reg);
                },
                error: function (reg) {
                    //alert("伺服器錯誤..........")
                    alert(JSON.stringify(reg));
                    //return callout(destination);
                }
            });
        }

        function checkStatus(number_id) {
            console.log("checkStatus >......");
            $.ajax({
                "async": true,
                "crossDomain": true,
                //"url": caserverurl + '/status/' + name + '?stationid=' + stationid,
                "url": 'https://tstiticctcstest.herokuapp.com/phone' + '/status/' + name + '?stationid=' +
                    stationid,
                "method": "GET",
                headers: {
                    'x-access-token': Mytoken,
                    'Access-Control-Allow-Origin': "*",
                    "cache-control": "no-cache"
                },
                success: function (reg) {
                    if (reg.success === false) {
                        if (reg.message === 'Can not find station status: ' + stationid) {
                            while (secondcount < 1) {
                                secondcount++;
                                setTimeout(function () {
                                    return checkStatus(number_id)
                                }, 1000);
                                $('#showtext'+showtext).text("");
                            } //end while
                        } else {
                            if (secondcount < 1) {
                                secondcount++;
                                $('#showtext'+showtext).text("檢查連線中...");
                                //setTimeout(checkStatus,1000);
                                setTimeout(function () {
                                    return checkStatus(number_id)
                                }, 1000);
                            } else {
                                $('#showtext'+showtext).text("連線失敗!......");
                            }
                        }
                    } else {
                        var callstatus = reg.status.status;
                        callid = reg.status.callid;
                        switch (callstatus) {
                            case "oncallconnect": //通話中
                                $('#camakecall' + number_id).hide();
                                $('#caholdcall' + number_id).show();
                                $('#caretrievecall' + number_id).hide();
                                $('#caendcall' + number_id).show();
                                //$('#showtext'+showtext).text("通話中~");
                                setTimeout(function () {
                                    return checkStatus(number_id)
                                }, 1000);
                                break;
                            case "oncallcreate": //撥號中
                                $('#camakecall' + number_id).hide();
                                $('#caendcall' + number_id).show();
                                //$('#showtext'+showtext).text("撥號中...");
                                setTimeout(function () {
                                    return checkStatus(number_id)
                                }, 1000);
                                break;
                            case "oncallend": //結束
                                $('#camakecall' + number_id).show();
                                $('#caholdcall' + number_id).hide();
                                $('#caretrievecall' + number_id).hide();
                                $('#caendcall' + number_id).hide();
                                $('#showtext'+showtext).text("");
                                break;
                            case "oncallhold": //保留中
                                $('#camakecall' + number_id).hide();
                                $('#caendcall' + number_id).show();
                                $('#caretrievecall' + number_id).show();
                                $('#caholdcall' + number_id).hide();
                                //$('#showtext'+showtext).text("保留中...");
                                setTimeout(function () {
                                    return checkStatus(number_id)
                                }, 1000);
                                break;
                            case "oncallring": //響鈴中
                                //do
                                break;
                            default:
                                //do
                        }
                    }
                },
                error: function (reg) {
                    if (name == '' || stationid == '' || caserverurl == '') {
                        //$('#showtext').text("請檢查撥號話機和使用者帳號!");
                    } else {
                        if (secondcount < 1) {
                            secondcount++;
                            //$('#showtext').text("連線錯誤!..........");
                            setTimeout(function () {
                                return checkStatus(number_id)
                            }, 1000);
                        }
                    }
                }
            });

        };
        $(document).ready(function () {
            $('#pagelogout').click(function () {
                alert('尚未完成');
            });
        });
    </script>

</body>

</html>